---
title: "ChrisEscobedo_A6"
author: "Chris"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: html_document
---

```{r, include = F}
knitr::opts_chunk$set(echo = F, warnings = F, message = F)
```

```{r, include = F}
library(tidyverse)
library(mapview)
library(sf)
library(leaflet)
library(tigris)
library(censusapi)

Sys.setenv(CENSUS_KEY="c7ce771b506b13ca6875d12a179606f8087fa381")
```

```{r}
ca_pumas <-
  pumas("CA", cb = T, progress_bar = F)

sf_boundary <-
  counties("CA", cb = T, progress_bar = F) %>%
  filter(NAME == "San Francisco")

sf_pumas <-
  ca_pumas %>% 
  st_centroid() %>% 
  .[sf_boundary, ] %>% 
  st_drop_geometry() %>% 
  left_join(ca_pumas %>% select(GEOID10)) %>% 
  st_as_sf()
```

## Map of San Francisco PUMAS

```{r}
mapview(sf_pumas)
```

There are a few geographical anomalies that appear on this map, including part of Angel Island, a sliver of Alameda, and the Farallon Islands. These will be ignored as they will not affect the analysis.

```{r}
pums_2019_1yr <- getCensus(
   name = "acs/acs1/pums",
   vintage = 2019,
   region = "public use microdata area:*",
   regionin = "state:06",
   vars = c(
     "SERIALNO",
     "SPORDER",
     "PWGTP",
     "WGTP",
     "YBL",
     "BLD",
     "TEN",
     "MV",
     "HINCP",
     "AGEP"
   )
 )
saveRDS(pums_2019_1yr, "a6_pums.rds")
```

```{r}
sf_pums <- pums_2019_1yr %>% 
  mutate (
    PUMA = str_pad(public_use_microdata_area, 5, "left", "0")
  ) %>% 
  filter(
    PUMA %in% sf_pumas$PUMACE10
  ) %>% 
  mutate(
    YBL = as.numeric(YBL),
    AGEP = as.numeric(AGEP),
    HINCP= as.numeric(HINCP)
  ) %>% 
  filter(
    YBL %in% 1:3
  ) %>% 
  group_by(SERIALNO) %>% 
  summarize(
    Age_min = min(AGEP, na.rm = T),
    WGTP = first(WGTP), 
    YBL = first(YBL), 
    BLD = first(BLD),
    TEN = first(TEN), 
    MV = first(MV), 
    HINCP = first(HINCP), 
    PUMA = first(PUMA)
  ) %>% 
  mutate(
    leadrisk = 
      (ifelse(
        HINCP < 90000 & Age_min < 6,
        1,
        0
        )
      )
  )
```

## Lead Risk Model

To create a model that could predict lead risk, a variable for lead risk was created by using PUMS data to find all houses with less than 90,000 annual income and at least one child under 6 years old.

The model uses the lead risk variable as the predicted variable, and uses BLD (Units in structure, TEN (Tenure), MV (When moved into this house or apartment), and PUMA (Public use microdata area code) as the predictors.

#### Summary of Model

```{r}
sf_pums_factors <- sf_pums %>% 
  mutate(
    BLD = BLD %>% 
      factor(
        levels = sf_pums$BLD %>% 
          unique() %>%
          as.numeric() %>% 
          sort()
      ),
    TEN = TEN %>% 
      factor(
        levels = sf_pums$TEN %>% 
          unique() %>%
          as.numeric() %>% 
          sort()
      ),
    MV = MV %>% 
      factor(
        levels = sf_pums$MV %>% 
          unique() %>%
          as.numeric() %>% 
          sort()
      ),
    PUMA = PUMA %>% 
      factor(
        levels = sf_pums$PUMA %>% 
          unique() %>% 
          sort()
      )
  )

logit_model <- glm(
  leadrisk ~ BLD + TEN + MV + PUMA,
  family = quasibinomial(),
  data = sf_pums_factors
)

summary(logit_model)
```

#### Example of Predicted Score

The following is an example of a predicted score, using a random sample from the data. The random sample is labeled "example_row" in the table below and provides its predictor variables. Below that is the predicted score for lead risk for the random sample, which is .

```{r}
example_row <- sample_n(sf_pums_factors,1)

example_row

predict(logit_model, data.frame(example_row), type = "response")
```










