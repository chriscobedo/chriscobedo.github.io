---
title: "ChrisEscobedo_A4"
author: "Chris"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: html_document
---

```{r, include = F}
knitr::opts_chunk$set(echo = F, warnings = F, message = F)
```

```{r, warning=FALSE}
library(lehdr)
library(tidyverse)
library(tigris)
library(sf)
library(leaflet)
library(censusapi)
library(raster)
library(mapview)
library(stars)
library(mapboxapi)

Sys.setenv(CENSUS_KEY="c7ce771b506b13ca6875d12a179606f8087fa381")
```

## Belle Haven

The analysis centered on Belle Haven, a historically under-resourced neighborhood in Menlo Park. The map below shows the three census block groups that make up the neighborhood and which will be used for the analysis. 

```{r, include=FALSE, warning = F}
# Belle Haven CBGs - 	060816117001,	060816117002, 060816117003
bh_boundary <- block_groups("CA", "San Mateo") %>% 
  filter(GEOID %in% c("060816117001",	"060816117002", "060816117003")) 

cbg_pal <- colorNumeric(
  palette = "Purples",
  domain = as.numeric(bh_boundary$GEOID)
)
```


```{r, warning = F}
leaflet() %>% 
  addMapboxTiles(
    style_id = "satellite-streets-v11",
    username = "mapbox",
    options = tileOptions(opacity = 0.8)
  ) %>% 
  addPolygons(
    data = bh_boundary,
    fillColor = "violet",
    color = "purple",
    opacity = 1,
    fillOpacity = .5,
    weight = 2,
    label = ~paste0(
      "CBG: ", 
      GEOID
    ),
    highlightOptions = highlightOptions(
      weight = 4,
      opacity = 5
    )
  ) 
```

## Creating Flood Maps

This analysis uses Data from OCOF on flood risk to Belle Haven, given nine different potential scenarios of sea level rise and storm frequency.

```{r, include=FALSE, warning = F}

for(slr in c("000","025","050")){
  
  for(rp in c("001","020","100")){
    
    print(paste0("SLR",slr,"_RP",rp))
    
    path <- paste0("/Volumes/GoogleDrive/Shared drives/SFBI/Data Library/OCOF/san_mateo_flooding_slr", slr, "/flooding/v2.1/county_san_mateo_flddepth_slr", slr, "_w", rp, ".tif")
    
    flood <- raster(path) %>% 
      crop(
        bh_boundary %>% 
          st_transform(26910) %>% 
          st_bbox()
      )
    
    writeRaster(flood, paste0("flood/SLR",slr,"_RP",rp,"_bh_flood.tif"), overwrite = T)
  }
}

SLR000_RP001 <- raster("flood/SLR000_RP001_bh_flood.tif")
SLR000_RP020 <- raster("flood/SLR000_RP020_bh_flood.tif")
SLR000_RP100 <- raster("flood/SLR000_RP100_bh_flood.tif")

SLR025_RP001 <- raster("flood/SLR025_RP001_bh_flood.tif")
SLR025_RP020 <- raster("flood/SLR025_RP020_bh_flood.tif")
SLR025_RP100 <- raster("flood/SLR025_RP100_bh_flood.tif")

SLR050_RP001 <- raster("flood/SLR050_RP001_bh_flood.tif")
SLR050_RP020 <- raster("flood/SLR050_RP020_bh_flood.tif")
SLR050_RP100 <- raster("flood/SLR050_RP100_bh_flood.tif")
```

Below is a map of of the maximum flood risk for Belle Haven. The maximum risk assumes a sea level rise of 50 centimeters and a storm strength that only occurs every 100 years. 

```{r, warning = F}
flood_max <- raster("flood/SLR050_RP100_bh_flood.tif")

flood_pal <- colorNumeric(
  palette = "Blues",
  domain = values(flood_max),
  na.color = "transparent"
)

leaflet() %>% 
  addMapboxTiles(
    style_id = "satellite-streets-v11",
    username = "mapbox",
    options = tileOptions(opacity = 0.5)
  ) %>% 
  addRasterImage(
    flood_max,
    colors = flood_pal
  ) %>% 
  addLegend(
    pal = flood_pal,
    values = values(flood_max),
    title = "Flood depth, cm"
  )
```

## Building Analysis

building data from...

below is a map of the buildings that would be impacted by the max flooding event in Belle Haven. 

```{r, include=FALSE, warning=FALSE}
osm_bldg <- st_read("/Volumes/GoogleDrive/Shared drives/SFBI/Data Library/OSM/gis_osm_buildings_a_free_1.shp")

bh_boundary_tf <- bh_boundary %>% st_transform(4326)

bh_bldg <- osm_bldg[bh_boundary_tf, ]

flood_max_extent <- 
  flood_max %>% 
  st_as_stars() %>% 
  mutate(SLR050_RP100_bh_flood = ifelse(
    !is.na(SLR050_RP100_bh_flood),
    1,
    NA
  )) %>% 
  st_as_sf(merge = T) %>% 
  st_set_crs(26910) %>% 
  st_make_valid() %>% 
  st_transform(4326)

bh_bldg_flooded_max <-
  bh_bldg %>% 
  st_transform(4326) %>% 
  .[flood_max_extent,]

flood_pal <- colorNumeric(
  palette = "Blues",
  domain = values(flood_max),
  na.color = "transparent"
)
```

Below is a map of ...

```{r, warning=FALSE}
leaflet() %>% 
  addMapboxTiles(
    style_id = "satellite-streets-v11",
    username = "mapbox",
    options = tileOptions(opacity = 0.5)
  ) %>% 
  addRasterImage(
    flood_max,
    colors = flood_pal,
    opacity = 0.75
  ) %>% 
  addPolygons(
    data = bh_bldg_flooded_max,
    fill = F,
    color = "red",
    weight = 0.5
  ) %>% 
  addLegend(
    pal = flood_pal,
    values = values(flood_max),
    title = "Flood depth, cm"
  )
```

building analysis maps

```{r}
if_else(minValue(SLR000_RP001)  )

bh_bldg_exposure <- NULL

for(slr in c("000","025","050")){
  
  for(rp in c("001","020","100")){
    
    print(paste0("SLR",slr,"_RP",rp))
    
    flood <- raster( paste0("flood/SLR",slr,"_RP",rp,"_bh_flood.tif"))
    
    flood_extent <- 
      (flood > -Inf) %>% 
      st_as_stars() %>% 
      st_as_sf(merge = T) %>% 
      st_set_crs(26910) %>% 
      st_make_valid() %>% 
      st_transform(4326)
    
    bh_bldg_flooded <-
      bh_bldg_flooded_max[flood_extent,] %>% 
      st_transform(26910)
    
    flood[is.na(flood)] <- 0
    
    flood_crop <-
      crop(flood, bh_bldg_flooded)
    
    temp <-
      extract(
        flood_crop,
        bh_bldg_flooded,
        fun = mean
      ) %>% 
      as.data.frame() %>% 
      rename(avg_depth = V1) %>% 
      cbind(
        epa_bldg_flooded %>% 
          st_drop_geometry() %>% 
          dplyr::select(osm_id)
      ) %>% 
      mutate(
        SLR = slr,
        RP = rp
      )
    
    bh_bldg_exposure <- 
      bh_bldg_exposure %>% 
      rbind(temp)
    
  }
}

saveRDS(bh_bldg_exposure,"bh_bldg_exposure.rds")
```




