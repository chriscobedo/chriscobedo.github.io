---
title: "ChrisEscobedo_A4"
author: "Chris"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: html_document
---

```{r, include = F}
knitr::opts_chunk$set(echo = F, warnings = F, message = F)
```

```{r, warning=FALSE}
library(lehdr)
library(tidyverse)
library(tigris)
library(sf)
library(leaflet)
library(censusapi)
library(raster)
library(mapview)
library(stars)
library(mapboxapi)
library(plotly)
library(jsonlite)

Sys.setenv(CENSUS_KEY="c7ce771b506b13ca6875d12a179606f8087fa381")
```

## Belle Haven

The analysis centered on Belle Haven, a historically under-resourced neighborhood in Menlo Park. The map below shows the three census block groups that make up the neighborhood and which will be used for the analysis. 

```{r, include=FALSE, warning = F}
# Belle Haven CBGs - 	060816117001,	060816117002, 060816117003
bh_boundary <- block_groups("CA", "San Mateo") %>% 
  filter(GEOID %in% c("060816117001",	"060816117002", "060816117003")) 

cbg_pal <- colorNumeric(
  palette = "Purples",
  domain = as.numeric(bh_boundary$GEOID)
)
```


```{r, warning = F}
leaflet() %>% 
  addMapboxTiles(
    style_id = "satellite-streets-v11",
    username = "mapbox",
    options = tileOptions(opacity = 0.8)
  ) %>% 
  addPolygons(
    data = bh_boundary,
    fillColor = "violet",
    color = "purple",
    opacity = 1,
    fillOpacity = .5,
    weight = 2,
    label = ~paste0(
      "CBG: ", 
      GEOID
    ),
    highlightOptions = highlightOptions(
      weight = 4,
      opacity = 5
    )
  ) 
```

## Creating Flood Maps

This analysis uses Data from OCOF on flood risk to Belle Haven, given nine different potential scenarios of sea level rise and storm frequency.

```{r, include=FALSE, warning = F}

for(slr in c("000","025","050")){
  
  for(rp in c("001","020","100")){
    
    print(paste0("SLR",slr,"_RP",rp))
    
    path <- paste0("/Volumes/GoogleDrive/Shared drives/SFBI/Data Library/OCOF/san_mateo_flooding_slr", slr, "/flooding/v2.1/county_san_mateo_flddepth_slr", slr, "_w", rp, ".tif")
    
    flood <- raster(path) %>% 
      crop(
        bh_boundary %>% 
          st_transform(26910) %>% 
          st_bbox()
      )
    
    writeRaster(flood, paste0("flood/SLR",slr,"_RP",rp,"_bh_flood.tif"), overwrite = T)
  }
}
```

Below is a map of of the maximum flood risk for Belle Haven. The maximum risk assumes a sea level rise of 50 centimeters and a storm strength that only occurs every 100 years. 

```{r, warning = F}
flood_max <- raster("flood/SLR050_RP100_bh_flood.tif")

flood_pal <- colorNumeric(
  palette = "Blues",
  domain = values(flood_max),
  na.color = "transparent"
)

leaflet() %>% 
  addMapboxTiles(
    style_id = "satellite-streets-v11",
    username = "mapbox",
    options = tileOptions(opacity = 0.5)
  ) %>% 
  addRasterImage(
    flood_max,
    colors = flood_pal
  ) %>% 
  addLegend(
    pal = flood_pal,
    values = values(flood_max),
    title = "Flood depth, cm"
  )
```

## Building Analysis

Next, the report will use building footprint data from OpenStreetMap to determine damage and construct an estimate of where population and vehicles are located.

Below is a map of the buildings that would be impacted by the max flooding event in Belle Haven. 

```{r, include=FALSE, warning=FALSE}
osm_bldg <- st_read("/Volumes/GoogleDrive/Shared drives/SFBI/Data Library/OSM/gis_osm_buildings_a_free_1.shp")

bh_boundary_tf <- bh_boundary %>% st_transform(4326)

bh_bldg <- osm_bldg[bh_boundary_tf, ]

flood_max_extent <- 
  flood_max %>% 
  st_as_stars() %>% 
  mutate(SLR050_RP100_bh_flood = ifelse(
    !is.na(SLR050_RP100_bh_flood),
    1,
    NA
  )) %>% 
  st_as_sf(merge = T) %>% 
  st_set_crs(26910) %>% 
  st_make_valid() %>% 
  st_transform(4326)

bh_bldg_flooded_max <-
  bh_bldg %>% 
  st_transform(4326) %>% 
  .[flood_max_extent,]

flood_pal <- colorNumeric(
  palette = "Blues",
  domain = values(flood_max),
  na.color = "transparent"
)
```


```{r, warning=FALSE}
leaflet() %>% 
  addMapboxTiles(
    style_id = "satellite-streets-v11",
    username = "mapbox",
    options = tileOptions(opacity = 0.5)
  ) %>% 
  addRasterImage(
    flood_max,
    colors = flood_pal,
    opacity = 0.75
  ) %>% 
  addPolygons(
    data = bh_bldg_flooded_max,
    fill = F,
    color = "red",
    weight = 0.5
  ) %>% 
  addLegend(
    pal = flood_pal,
    values = values(flood_max),
    title = "Flood depth, cm"
  )
```


```{r, warning=FALSE, include=FALSE}
# bh_bldg_exposure <- NULL
# 
# for(slr in c("050","025","000")){
#   
#   for(rp in c("100","020","001")){
#     
#     print(paste0("SLR",slr,"_RP",rp))
#     
#     flood <- raster( paste0("flood/SLR",slr,"_RP",rp,"_bh_flood.tif"))
#     
#     flood_extent <- 
#       (flood > -Inf) %>% 
#       st_as_stars() %>% 
#       st_as_sf(merge = T) %>% 
#       st_set_crs(26910) %>% 
#       st_make_valid() %>% 
#       st_transform(4326)
#       
#     bh_bldg_flooded <-
#       bh_bldg_flooded_max[flood_extent,] %>% 
#       st_transform(26910)
#       
#     if(!dim(bh_bldg_flooded)[1] == 0){
#       
#       flood[is.na(flood)] <- 0
#       
#       temp <- 
#         raster::extract(
#           flood,
#           bh_bldg_flooded,
#           fun = mean
#         ) %>% 
#         as.data.frame() %>% 
#         rename(avg_depth = V1) %>% 
#         cbind(
#           bh_bldg_flooded %>% 
#             st_drop_geometry() %>% 
#             dplyr::select(osm_id)
#         ) %>% 
#         mutate(
#           SLR = slr,
#           RP = rp
#         )
#       
#       bh_bldg_exposure <- 
#         bh_bldg_exposure %>% 
#         rbind(temp)
#     }
#   }
# }
# saveRDS(bh_bldg_exposure,"bh_bldg_exposure.rds")
#
```

### Vehicle data

To compile an estimate of vehicles per building, several data sources were used. 

Census data was used to get population data at the block level. Vehicle counts were retrieved from census data about vehicle availability per household. The total count of 2020 vehicles for the whole CBG were than matched to each building, assuming population was distributed evenly across buildings in a block, and vehicles were distributed evenly across the population.

EMFAC data was used to get a count for vehicles in the county, to be used for the rate of change of vehciles over decades

```{r, warning=FALSE, include=FALSE}
#get vehicle count

## vehicle percent change by decade
emfac <- 
  read_csv("/Users/Chris/Downloads/EMFAC_20-50.csv", skip = 8) %>% 
  transmute(
    year = `Calendar Year`,
    trips = Trips
  ) %>%
  filter(
    year %in% c(2020, 2030, 2040, 2050)
  ) %>% 
  group_by(year) %>% 
  summarize(total = sum(trips)) %>% 
  mutate(
    perc_change = (total - first(total)) / first(total)
  ) 

# vehicle count
acs_vars_2019_5yr <-
  listCensusMetadata(
    name = "2019/acs/acs5",
    type = "variables"
  )

vehicles_available_bh <- 
  getCensus(
      name = "acs/acs5",
      vintage = 2019,
      region = "block group:*",
      regionin = paste0("state:06+county:081"),
      vars = "group(B25044)"
  ) %>% 
    mutate(
    cbg =
      paste0(state,county,tract,block_group)
  ) %>% 
  filter(cbg %in% bh_boundary$GEOID) %>% 
  select(!c(GEO_ID,state,county,tract,block_group,NAME) & !ends_with(c("EA","MA","M"))) %>%
  pivot_longer(
    ends_with("E"),
    names_to = "variable",
    values_to = "estimate"
  ) %>%
  left_join(
    acs_vars_2019_5yr %>% 
      select(name, label), 
    by = c("variable" = "name")
  ) %>% 
  select(-variable) %>% 
  separate(
    label,
    into = c(NA, NA, "tenure", "vehicles_available"),
    sep = "!!"
  ) %>% 
  mutate(
    vehicles_available = case_when(
      vehicles_available %in% c(
        "No vehicle available"
      ) ~ 0,
      vehicles_available %in% c(
        "1 vehicle available"
      ) ~ 1,
      vehicles_available %in% c(
        "2 vehicles available"
      ) ~ 2,
      vehicles_available %in% c(
        "3 vehicles available"
      ) ~ 3,
      vehicles_available %in% c(
        "4 vehicles available"
      ) ~ 4,
      vehicles_available %in% c(
        "5 or more vehicles available"
      ) ~ 5,
    ),
    tenure = case_when(
      tenure %in% c(
        "Owner occupied:"
      ) ~ "owner",
      tenure %in% c(
        "Renter occupied:"
      ) ~ "renter",
    )
  ) %>% 
  filter(!is.na(vehicles_available) & !is.na(tenure)) 

total_vehicle_count <- vehicles_available_bh %>% 
  mutate(
    total = estimate * vehicles_available
  ) %>% 
  group_by(cbg) %>% 
  summarize(estimate = sum(total))

vehicle_count_decade <- total_vehicle_count %>% 
  mutate(
    year = 2020
  ) %>% 
  rbind(total_vehicle_count %>% 
   mutate(
    year = 2030
    )
  ) %>% 
  rbind(total_vehicle_count %>% 
   mutate(
    year = 2040
    )
  ) %>% 
  rbind(total_vehicle_count %>% 
   mutate(
    year = 2050
    )
  ) %>% 
  left_join(emfac) %>% 
  mutate(
    estimate = (estimate * perc_change) + estimate
  ) %>% 
  select(cbg,estimate,year)

## number of households with 1 or 0 vehicles available
bh_limited_vehicles <- vehicles_available_bh %>% 
  filter(vehicles_available %in% c(0,1)) %>% 
  group_by(cbg, vehicles_available) %>% 
  summarize(total = sum(estimate))
  
#get population
bh_blocks <- blocks("CA", "San Mateo") %>% 
  mutate(
    cbg = substr(GEOID10,1,12)
  ) %>% 
  filter(cbg %in% c("060816117001",	"060816117002", "060816117003")) 

pop_2020 <-
  getCensus(
    name = "dec/pl",
    vintage = 2020,
    region = "block:*", 
    regionin = "state:06+county:081",
    vars = "P1_001N"
  ) %>% 
  transmute(
    block =
      paste0(state,county,tract,block),
    pop = P1_001N
  )

bh_pop_2020 <- pop_2020 %>% 
  left_join(bh_blocks %>% select(block = GEOID10)) %>% 
  st_as_sf() %>% 
  st_centroid() %>% 
  .[bh_blocks, ] %>% 
  st_drop_geometry() %>% 
  left_join(bh_blocks %>% select(block = GEOID10)) %>% 
  st_as_sf()

## attach vehicles to buildings based on pop 
vehicles_to_buildings <- bh_bldg %>% 
  st_join(bh_boundary_tf) %>% 
  st_join(bh_pop_2020 %>% st_transform(4326)) %>% 
  left_join(total_vehicle_count %>% select(cbg, vehicle_total_cbg = estimate), by = c("GEOID" = "cbg")) %>% 
  select(osm_id, GEOID, block, pop, vehicle_total_cbg)

vehicles_to_buildings <- vehicles_to_buildings %>% 
  left_join(
    count(vehicles_to_buildings, vars=block) %>% select(vars, buildings_total_block = n) %>% st_drop_geometry(), 
    by = c("block" = "vars")
  ) %>% 
  left_join(
    (vehicles_to_buildings %>% group_by(GEOID) %>% filter(!is.na(pop)) %>% summarize(total_pop_cbg = sum(pop))) %>% st_drop_geometry() 
  ) %>% 
  filter(!is.na(pop) & pop!= 0) %>% 
  mutate(
    pop_building = pop / buildings_total_block,
    perc_pop = pop / total_pop_cbg,
    vehicles_by_block_pop = vehicle_total_cbg * perc_pop,
    perc_pop_building = pop_building / pop,
    vehicles_building = vehicles_by_block_pop * perc_pop_building
  ) %>% 
  distinct(osm_id, .keep_all = TRUE)
```

*Disclaimer: The census data retrieved for population was missing two blocks in the Northwestern area of Belle Haven. Although this area would likely be affected by flood risk, the data may show under-representation due to this lack of data. Those blocks were removed from the vehicle data, but they are technically part of Belle Haven and will not be represented.* 

```{r, warning=FALSE, include=FALSE}
vulnerability <- data.frame(
  depth = c(0,0.5,1:10),
  perc_damage = c(
    0,
    .076,
    0.28,
    0.462,
    0.622,
    0.76,
    0.876,
    0.97,
    0.100,
    0.100,
    0.100,
    0.100
  )
)

bh_bldg_exposure <-
  readRDS("bh_bldg_exposure.rds") %>%
  mutate(
    avg_depth = avg_depth*0.0328084 # cm to ft
  ) 

bh_vehicle_perc_damage_per_building <-
  approx(
    x = vulnerability$depth,
    y = vulnerability$perc_damage,
    xout = bh_bldg_exposure$avg_depth
  ) %>%
  .[2] %>%
  as.data.frame() %>%
  rename(perc_damage = y) %>%
  cbind(bh_bldg_exposure)

saveRDS(bh_vehicle_perc_damage_per_building,"bh_vehicle_perc_damage_per_building")

bh_vehicle_perc_damage_per_building <- readRDS("bh_vehicle_perc_damage_per_building")
```

## Plot of Vulnerability to Vehicle Damage

```{r, warning=FALSE}
bh_vehicle_perc_damage_plot <- 
  expand.grid(
    osm_id = unique(bh_vehicle_perc_damage_per_building$osm_id),
    SLR = unique(bh_vehicle_perc_damage_per_building$SLR),
    RP = unique(bh_vehicle_perc_damage_per_building$RP)
  ) %>% 
  left_join(bh_vehicle_perc_damage_per_building) %>% 
  mutate(
    avg_depth = ifelse(
      is.na(avg_depth),
      0,
      avg_depth
    ),
    perc_damage = ifelse(
      is.na(perc_damage),
      0,
      perc_damage
    )
  )

bh_plot <- 
  plot_ly() %>% 
  add_trace(
    data = 
      bh_vehicle_perc_damage_plot %>% 
        filter(RP == "100") %>% 
        mutate(SLR = SLR %>% as.numeric()),
    x = ~avg_depth,
    y = ~perc_damage,
    frame = ~SLR,
    type = 'scatter',
    mode = 'markers',
    marker = list(
      color = 'rgba(17, 157, 255, 0.01)',
      size = 15
    ),
    showlegend = F
  ) %>% 
  add_trace(
    data = vulnerability,
    x = ~depth,
    y = ~perc_damage,
    type = 'scatter',
    mode = 'markers',
    marker = list(
      color = 'rgb(0,0,0)'
    ),
    showlegend = F
  ) %>% 
  layout(
    xaxis = list(
      title = "Average Flood Depth",
      zeroline = FALSE
    ),
    yaxis = list(
      title = "Percent Damage"
    ),
    title = "Bell Haven Vehicle damage during<br>100-year storm, by base sea level rise"
  ) %>% 
  config(displayModeBar = F)
```

## Analysing Risk

The dollar amount used to estimate damage in money to each car was calculated using Kelly Blue Book's average price for a used car in 2022, which is $28,000. The price for a used car was chosen since the majority of car sales are for used cars.

```{r, warning=FALSE, include=FALSE}
bh_vehicle_damage <-
  bh_vehicle_perc_damage_per_building %>% 
  left_join(
    vehicles_to_buildings %>%
      st_drop_geometry() %>% 
      select(osm_id, vehicles_building)
  ) %>% 
  mutate(
    damage = vehicles_building * (28000) * perc_damage
  ) %>% 
  select(osm_id, SLR, RP, damage)

bh_vehicle_aal_by_slr <-
  bh_vehicle_damage %>% 
  pivot_wider(
    names_from = RP,
    values_from = damage
  ) %>% 
  replace(is.na(.), 0) %>% 
  mutate(
    damage = 
      0.95*(`020`)/2 + 
      0.04*(`020`+`100`)/2 + 
      0.01*(`100`)
  ) %>% 
  select(osm_id, SLR, damage)

rcp45 <- read_csv("https://raw.githubusercontent.com/stanfordfuturebay/stanfordfuturebay.github.io/master/advanced/rcp45_sanfrancisco.csv")

bh_vehicle_aal_by_year <- 
  bh_vehicle_aal_by_slr %>% 
  left_join(
    rcp45 %>% 
      mutate(
        SLR = str_pad(SLR, 3 , "left", "0")
      ) %>% 
      select(
        SLR,
        `2020`,
        `2030`,
        `2040`,
        `2050`
      )
  ) %>% 
  pivot_longer(
    `2020`:`2050`,
    names_to = "year",
    values_to = "occurrence"
  ) %>% 
  mutate(
    year = as.numeric(year)
  ) %>% 
  left_join(
    emfac %>% select(year, perc_change)
  ) %>% 
  mutate(
    damage = (damage * perc_change) + damage
  ) %>% 
  pivot_longer(
    c(damage,occurrence),
    names_to = "key",
    values_to = "value"
  ) %>% 
  pivot_wider(
    names_from = c("key","SLR"),
    values_from = value
  ) %>% 
  replace(is.na(.), 0) %>% 
  mutate(
    damage = 
      occurrence_050 * (damage_050)
  ) %>% 
  select(osm_id, year, damage)

```

Below is a map of the “average annualized loss” (AAL) for each building in vehicle damages for the year 2020 and 2050

```{r, warning=FALSE}
bh_vehicle_aal_by_year_map <-
  bh_vehicle_aal_by_year %>% 
  pivot_wider(
    names_from = year,
    values_from = damage
  ) %>% 
  mutate(
    change = `2050`-`2020`
  ) %>% 
  left_join(
    bh_bldg_flooded_max %>%
      select(osm_id)
  ) %>% 
  st_as_sf() %>% 
  st_transform(4326)

aal_pal <- colorNumeric(
  palette = "Reds",
  domain = c(0,bh_vehicle_aal_by_year_map$`2050`)
)

bh_vehicle_aal_by_year_map %>% 
  leaflet() %>% 
  addMapboxTiles(
    style_id = "light-v9",
    username = "mapbox"
  ) %>% 
  addPolygons(
    fillColor = ~aal_pal(`2020`),
    color = "gray",
    fillOpacity = 1,
    opacity = 1,
    weight = 0.25,
    highlightOptions = highlightOptions(
      color = "white",
      weight = 2
    ),
    label = ~paste0("$",prettyNum(signif(`2020`,2),",")," average annualized loss in 2020"),
    group = "2020"
  ) %>% 
  addPolygons(
    fillColor = ~aal_pal(`2050`),
    color = "gray",
    fillOpacity = 1,
    opacity = 1,
    weight = 0.25,
    highlightOptions = highlightOptions(
      color = "white",
      weight = 2
    ),
    label = ~paste0("$",prettyNum(signif(`2050`,2),",")," average annualized loss in 2050"),
    group = "2050"
  ) %>% 
  addPolygons(
    fillColor = ~aal_pal(change),
    color = "gray",
    fillOpacity = 1,
    opacity = 1,
    weight = 0.25,
    highlightOptions = highlightOptions(
      color = "white",
      weight = 2
    ),
    label = ~paste0("$",prettyNum(signif(change,2),",")," change in average annualized loss from 2020 to 2050"),
    group = "Change"
  ) %>% 
  addLegend(
    pal = aal_pal,
    values = ~`2050`,
    title = "AAL"
  ) %>% 
  addLayersControl(
    baseGroups = c("2020","2050","Change"),
    options = layersControlOptions(collapsed = FALSE)
  ) %>% 
  showGroup("2050")
```


## Discussion

There is reason to expect that the derived AAL are still underestimates, because they do not account for increasing storm frequency and severity due to climate change.








