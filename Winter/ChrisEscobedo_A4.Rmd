---
title: "ChrisEscobedo_A4"
author: "Chris"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: html_document
---

```{r, include = F}
knitr::opts_chunk$set(echo = F, warnings = F, message = F)
```

```{r, warning=FALSE}
library(lehdr)
library(tidyverse)
library(tigris)
library(sf)
library(leaflet)
library(censusapi)
library(raster)
library(mapview)
library(stars)
library(mapboxapi)
library(plotly)
library(jsonlite)

Sys.setenv(CENSUS_KEY="c7ce771b506b13ca6875d12a179606f8087fa381")
```

## Belle Haven

The analysis centered on Belle Haven, a historically under-resourced neighborhood in Menlo Park. The map below shows the three census block groups that make up the neighborhood and which will be used for the analysis. 

```{r, include=FALSE, warning = F}
# Belle Haven CBGs - 	060816117001,	060816117002, 060816117003
bh_boundary <- block_groups("CA", "San Mateo") %>% 
  filter(GEOID %in% c("060816117001",	"060816117002", "060816117003")) 

cbg_pal <- colorNumeric(
  palette = "Purples",
  domain = as.numeric(bh_boundary$GEOID)
)
```


```{r, warning = F}
leaflet() %>% 
  addMapboxTiles(
    style_id = "satellite-streets-v11",
    username = "mapbox",
    options = tileOptions(opacity = 0.8)
  ) %>% 
  addPolygons(
    data = bh_boundary,
    fillColor = "violet",
    color = "purple",
    opacity = 1,
    fillOpacity = .5,
    weight = 2,
    label = ~paste0(
      "CBG: ", 
      GEOID
    ),
    highlightOptions = highlightOptions(
      weight = 4,
      opacity = 5
    )
  ) 
```

## Creating Flood Maps

This analysis uses Data from OCOF on flood risk to Belle Haven, given nine different potential scenarios of sea level rise and storm frequency.

```{r, include=FALSE, warning = F}

for(slr in c("000","025","050")){
  
  for(rp in c("001","020","100")){
    
    print(paste0("SLR",slr,"_RP",rp))
    
    path <- paste0("/Volumes/GoogleDrive/Shared drives/SFBI/Data Library/OCOF/san_mateo_flooding_slr", slr, "/flooding/v2.1/county_san_mateo_flddepth_slr", slr, "_w", rp, ".tif")
    
    flood <- raster(path) %>% 
      crop(
        bh_boundary %>% 
          st_transform(26910) %>% 
          st_bbox()
      )
    
    writeRaster(flood, paste0("flood/SLR",slr,"_RP",rp,"_bh_flood.tif"), overwrite = T)
  }
}

SLR000_RP001 <- raster("flood/SLR000_RP001_bh_flood.tif")
SLR000_RP020 <- raster("flood/SLR000_RP020_bh_flood.tif")
SLR000_RP100 <- raster("flood/SLR000_RP100_bh_flood.tif")

SLR025_RP001 <- raster("flood/SLR025_RP001_bh_flood.tif")
SLR025_RP020 <- raster("flood/SLR025_RP020_bh_flood.tif")
SLR025_RP100 <- raster("flood/SLR025_RP100_bh_flood.tif")

SLR050_RP001 <- raster("flood/SLR050_RP001_bh_flood.tif")
SLR050_RP020 <- raster("flood/SLR050_RP020_bh_flood.tif")
SLR050_RP100 <- raster("flood/SLR050_RP100_bh_flood.tif")
```

Below is a map of of the maximum flood risk for Belle Haven. The maximum risk assumes a sea level rise of 50 centimeters and a storm strength that only occurs every 100 years. 

```{r, warning = F}
flood_max <- raster("flood/SLR050_RP001_bh_flood.tif")

flood_pal <- colorNumeric(
  palette = "Blues",
  domain = values(flood_max),
  na.color = "transparent"
)

leaflet() %>% 
  addMapboxTiles(
    style_id = "satellite-streets-v11",
    username = "mapbox",
    options = tileOptions(opacity = 0.5)
  ) %>% 
  addRasterImage(
    flood_max,
    colors = flood_pal
  ) %>% 
  addLegend(
    pal = flood_pal,
    values = values(flood_max),
    title = "Flood depth, cm"
  )
```

## Building Analysis

building data from...

below is a map of the buildings that would be impacted by the max flooding event in Belle Haven. 

```{r, include=FALSE, warning=FALSE}
osm_bldg <- st_read("/Volumes/GoogleDrive/Shared drives/SFBI/Data Library/OSM/gis_osm_buildings_a_free_1.shp")

bh_boundary_tf <- bh_boundary %>% st_transform(4326)

bh_bldg <- osm_bldg[bh_boundary_tf, ]

flood_max_extent <- 
  flood_max %>% 
  st_as_stars() %>% 
  mutate(SLR050_RP100_bh_flood = ifelse(
    !is.na(SLR050_RP100_bh_flood),
    1,
    NA
  )) %>% 
  st_as_sf(merge = T) %>% 
  st_set_crs(26910) %>% 
  st_make_valid() %>% 
  st_transform(4326)

bh_bldg_flooded_max <-
  bh_bldg %>% 
  st_transform(4326) %>% 
  .[flood_max_extent,]

flood_pal <- colorNumeric(
  palette = "Blues",
  domain = values(flood_max),
  na.color = "transparent"
)
```

Below is a map of ...

```{r, warning=FALSE}
leaflet() %>% 
  addMapboxTiles(
    style_id = "satellite-streets-v11",
    username = "mapbox",
    options = tileOptions(opacity = 0.5)
  ) %>% 
  addRasterImage(
    flood_max,
    colors = flood_pal,
    opacity = 0.75
  ) %>% 
  addPolygons(
    data = bh_bldg_flooded_max,
    fill = F,
    color = "red",
    weight = 0.5
  ) %>% 
  addLegend(
    pal = flood_pal,
    values = values(flood_max),
    title = "Flood depth, cm"
  )
```

building analysis maps

```{r, warning=FALSE, include=FALSE}
# bh_bldg_exposure <- NULL
# 
# for(slr in c("050","025","000")){
#   
#   for(rp in c("100","020","001")){
#     
#     print(paste0("SLR",slr,"_RP",rp))
#     
#     flood <- raster( paste0("flood/SLR",slr,"_RP",rp,"_bh_flood.tif"))
#     
#     flood_extent <- 
#       (flood > -Inf) %>% 
#       st_as_stars() %>% 
#       st_as_sf(merge = T) %>% 
#       st_set_crs(26910) %>% 
#       st_make_valid() %>% 
#       st_transform(4326)
#       
#     bh_bldg_flooded <-
#       bh_bldg_flooded_max[flood_extent,] %>% 
#       st_transform(26910)
#       
#     if(!dim(bh_bldg_flooded)[1] == 0){
#       
#       flood[is.na(flood)] <- 0
#       
#       temp <- 
#         raster::extract(
#           flood,
#           bh_bldg_flooded,
#           fun = mean
#         ) %>% 
#         as.data.frame() %>% 
#         rename(avg_depth = V1) %>% 
#         cbind(
#           bh_bldg_flooded %>% 
#             st_drop_geometry() %>% 
#             dplyr::select(osm_id)
#         ) %>% 
#         mutate(
#           SLR = slr,
#           RP = rp
#         )
#       
#       bh_bldg_exposure <- 
#         bh_bldg_exposure %>% 
#         rbind(temp)
#     }
#   }
# }
# saveRDS(bh_bldg_exposure,"bh_bldg_exposure.rds")
#
```


```{r, warning=FALSE, include=FALSE}
#get vehicle count

## vehicle percent change by decade
emfac <- 
  read_csv("/Users/Chris/Downloads/EMFAC_20-50.csv", skip = 8) %>% 
  transmute(
    year = `Calendar Year`,
    trips = Trips
  ) %>%
  filter(
    year %in% c(2020, 2030, 2040, 2050)
  ) %>% 
  group_by(year) %>% 
  summarize(total = sum(trips)) %>% 
  mutate(
    perc_change = (total - lag(total)) / lag(total)
  ) 

# vehicle count
acs_vars_2019_5yr <-
  listCensusMetadata(
    name = "2019/acs/acs5",
    type = "variables"
  )

vehicles_available_bh <- 
  getCensus(
      name = "acs/acs5",
      vintage = 2019,
      region = "block group:*",
      regionin = paste0("state:06+county:081"),
      vars = "group(B25044)"
  ) %>% 
    mutate(
    cbg =
      paste0(state,county,tract,block_group)
  ) %>% 
  filter(cbg %in% bh_boundary$GEOID) %>% 
  select(!c(GEO_ID,state,county,tract,block_group,NAME) & !ends_with(c("EA","MA","M"))) %>%
  pivot_longer(
    ends_with("E"),
    names_to = "variable",
    values_to = "estimate"
  ) %>%
  left_join(
    acs_vars_2019_5yr %>% 
      select(name, label), 
    by = c("variable" = "name")
  ) %>% 
  select(-variable) %>% 
  separate(
    label,
    into = c(NA, NA, "tenure", "vehicles_available"),
    sep = "!!"
  ) %>% 
  mutate(
    vehicles_available = case_when(
      vehicles_available %in% c(
        "No vehicle available"
      ) ~ 0,
      vehicles_available %in% c(
        "1 vehicle available"
      ) ~ 1,
      vehicles_available %in% c(
        "2 vehicles available"
      ) ~ 2,
      vehicles_available %in% c(
        "3 vehicles available"
      ) ~ 3,
      vehicles_available %in% c(
        "4 vehicles available"
      ) ~ 4,
      vehicles_available %in% c(
        "5 or more vehicles available"
      ) ~ 5,
    ),
    tenure = case_when(
      tenure %in% c(
        "Owner occupied:"
      ) ~ "owner",
      tenure %in% c(
        "Renter occupied:"
      ) ~ "renter",
    )
  ) %>% 
  filter(!is.na(vehicles_available) & !is.na(tenure)) 

total_vehicle_count <- vehicles_available_bh %>% 
  mutate(
    total = estimate * vehicles_available
  ) %>% 
  group_by(cbg) %>% 
  summarize(estimate = sum(total))

decade_change <- emfac %>% 
  

vehicle_count_decade <- total_vehicle_count %>% 
  mutate(
    year = 2020
  ) %>% 
  rbind(total_vehicle_count %>% 
   mutate(
    year = 2030
    )
  ) %>% 
  rbind(total_vehicle_count %>% 
   mutate(
    year = 2040
    )
  ) %>% 
  rbind(total_vehicle_count %>% 
   mutate(
    year = 2050
    )
  ) 



  
```


```{r, warning=FALSE, include=FALSE}
#get population
bh_blocks <- blocks("CA", "San Mateo") %>% 
  mutate(
    cbg = substr(GEOID10,1,12)
  ) %>% 
  filter(cbg %in% c("060816117001",	"060816117002", "060816117003")) 

pop_2020 <-
  getCensus(
    name = "dec/pl",
    vintage = 2020,
    region = "block:*", 
    regionin = "state:06+county:081,085",
    vars = "P1_001N"
  ) %>% 
  transmute(
    block =
      paste0(state,county,tract,block),
    pop = P1_001N
  )

bh_pop_2020 <- pop_2020 %>% 
  left_join(bh_blocks %>% select(block = GEOID10)) %>% 
  st_as_sf() %>% 
  st_centroid() %>% 
  .[bh_blocks, ] %>% 
  st_drop_geometry() %>% 
  left_join(bh_blocks %>% select(block = GEOID10)) %>% 
  st_as_sf()

mapview(bh_pop_2020)

## attach vehicles to buildings based on pop 

```


```{r, warning=FALSE, include=FALSE}
vulnerability <- data.frame(
  depth = c(0,0.5,1:10),
  perc_damage = c(
    0,
    .076,
    0.28,
    0.462,
    0.622,
    0.76,
    0.876,
    0.97,
    0.100,
    0.100,
    0.100,
    0.100
  )
)

bh_bldg_exposure <-
  readRDS("bh_bldg_exposure.rds") %>%
  mutate(
    avg_depth = avg_depth*0.0328084 # cm to ft
  )

bh_bldg_perc_damage <-
  approx(
    x = vulnerability$depth,
    y = vulnerability$perc_damage,
    xout = bh_bldg_exposure$avg_depth
  ) %>%
  .[2] %>%
  as.data.frame() %>%
  rename(perc_damage = y) %>%
  cbind(bh_bldg_exposure)

saveRDS(bh_bldg_perc_damage,"bh_bldg_perc_damage.rds")

bh_bldg_perc_damage <- readRDS("bh_bldg_perc_damage.rds")
```






```{r, warning=FALSE}

```


## Discussion

There is reason to expect that the derived AAL are still underestimates, because they do not account for increasing storm frequency and severity due to climate change.








