---
title: "ChrisEscobedo_A5"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: fill
---

```{r global, include=FALSE}
library(lehdr)
library(tidyverse)
library(tigris)
library(sf)
library(leaflet)
library(censusapi)
library(raster)
library(mapview)
library(stars)
library(mapboxapi)
library(plotly)
library(jsonlite)
library(flexdashboard)

Sys.setenv(CENSUS_KEY="c7ce771b506b13ca6875d12a179606f8087fa381")
```

Data from purple air

```{r global, include = FALSE}
## PART 1 
pa_api <- "F5058268-99B3-11EC-B9BF-42010A800003"

json <- fromJSON(paste0(
    "https://api.purpleair.com/v1/sensors?api_key=",
    pa_api,
    "&fields=name,location_type,latitude,longitude,pm2.5_1week,temperature,humidity,primary_id_a,primary_key_a,secondary_id_a,secondary_key_a,primary_id_b,primary_key_b,secondary_id_b,secondary_key_b"
  ))

all_sensors <- json %>% 
  .$data %>% 
  as.data.frame() %>% 
  set_names(json$fields) %>% 
  filter(
    !is.na(longitude),
    !is.na(latitude)
  ) %>% 
  st_as_sf(coords = c("longitude","latitude"), crs = 4326) %>% 
  mutate(location_type = ifelse(
    location_type == 0,
    "outside",
    "inside"
  ))

smc_sensors <-
  all_sensors %>% 
  .[counties("CA") %>% filter(NAME == "San Mateo") %>% st_transform(4326), ]






## FROM CLASS DEMO

# smc_places <- places("CA", cb = T) %>%
#  st_centroid() %>%   
#  .[counties("CA") %>% filter(NAME == "San Mateo"),] %>%
#   st_drop_geometry() %>%
#   left_join(places("CA", cb = T) %>% select(PLACEFP)) %>%   
#   st_as_sf()
# saveRDS(smc_places, "smc_places.rds")
smc_places <- readRDS("smc_places.rds")

# smc_cbgs <- block_groups("CA","San Mateo", cb = T)
# saveRDS(smc_cbgs, "smc_cbgs.rds")
smc_cbgs <- readRDS("smc_cbgs.rds")
```

Inputs {.sidebar}
-------------------------------------

```{r}
selectInput(
  inputId = "city", 
  label = "Jurisdiction:",
  choices = c("", smc_places$NAME), 
  ## selected = "East Palo Alto"
)
```

Column
-------------------------------------

### Plot

```{r}
plotlyOutput("plot")
```

```{r, context = "server"}
observeEvent(input$city, {
  
  chart <- smc_places %>% 
    filter(NAME == input$city) %>% 
    ggplot(
      aes(
        x = ALAND,
        y = AWATER
      )
    ) +
    geom_point()
  
  output$plot <- renderPlotly({
    chart %>% 
      ggplotly() %>% 
      config(displayModeBar = F)
  })
  
})
```

Column
-------------------------------------

### Map

```{r}
leafletOutput("map")
```

```{r, context = "server"}
cbg_pal <- colorNumeric(
  palette = "RdYlGn",
  domain = 
    smc_cbgs$ALAND
)
  
output$map <- renderLeaflet({
  leaflet() %>% 
    addProviderTiles(provider = providers$CartoDB.Positron) %>% 
    addPolygons(
      data = smc_cbgs,
      fillColor = ~cbg_pal(ALAND),
      color = "white",
      opacity = 0.5,
      fillOpacity = 0.5,
      weight = 1,
      highlightOptions = highlightOptions(
        weight = 2,
        opacity = 1
      )
    )
})
```

```{r, context = "server"}
observeEvent(input$city, {
  
  selected <- smc_places %>% 
    filter(NAME == input$city)
  
  leafletProxy("map") %>% 
    removeShape("selected") %>% 
    addPolygons(
      data = selected,
      fill = F,
      color = "black",
      weight = 2,
      opacity = 1,
      layerId = "selected"
    )
  
})
```

















