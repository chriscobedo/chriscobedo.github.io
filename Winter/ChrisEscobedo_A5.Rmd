---
title: "ChrisEscobedo_A5"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: fill
---

```{r global, include=FALSE}
library(lehdr)
library(tidyverse)
library(tigris)
library(sf)
library(leaflet)
library(censusapi)
library(raster)
library(mapview)
library(stars)
library(mapboxapi)
library(plotly)
library(jsonlite)
library(flexdashboard)

Sys.setenv(CENSUS_KEY="c7ce771b506b13ca6875d12a179606f8087fa381")
```

Data from purple air

```{r global, include = FALSE}
## PART 1 
pa_api <- "F5058268-99B3-11EC-B9BF-42010A800003"

json <- fromJSON(paste0(
    "https://api.purpleair.com/v1/sensors?api_key=",
    pa_api,
    "&fields=name,location_type,latitude,longitude,pm2.5_1week,temperature,humidity,primary_id_a,primary_key_a,secondary_id_a,secondary_key_a,primary_id_b,primary_key_b,secondary_id_b,secondary_key_b"
  ))

all_sensors <- json %>% 
  .$data %>% 
  as.data.frame() %>% 
  set_names(json$fields) %>% 
  filter(
    !is.na(longitude),
    !is.na(latitude)
  ) %>% 
  st_as_sf(coords = c("longitude","latitude"), crs = 4326) %>% 
  mutate(location_type = ifelse(
    location_type == 0,
    "outside",
    "inside"
  ))

smc_sensors <-
  all_sensors %>% 
  .[counties("CA") %>% filter(NAME == "San Mateo") %>% st_transform(4326), ]

smc_sensors_clean <- smc_sensors %>% 
  filter(
    !is.na(pm2.5_1week),
    !is.na(humidity)
  ) %>% 
  mutate(
    PM25 = 0.524*as.numeric(pm2.5_1week) - 0.0852*as.numeric(humidity) + 5.72,
    AQI = case_when(
      PM25 <= 12 ~ 
        paste(round(50/12*PM25), "Good"),
      PM25 <= 35.4 ~ 
        paste(round((100-51)/(35.4-12)*(PM25 - 12) + 51), "Moderate"),
      PM25 <= 55.4 ~
        paste(round((150-101)/(55.4-35.4)*(PM25 - 35.4) + 101), "Moderately Unhealthy"),
      PM25 <= 150.4 ~
        paste(round((200-151)/(150.4-55.4)*(PM25 - 55.4) + 151), "Unhealthy"),
      PM25 <= 250.4 ~
        paste(round((300-201)/(250.4-150.4)*(PM25 - 150.4) + 201), "Very Unhealthy"),
      TRUE ~ 
        paste(round((500-301)/(500.4-250.5)*(PM25 - 250.5) + 301), "Hazardous")
    )
  ) %>% 
  separate(
    AQI,
    into = c("AQI","AQI_Cat"),
    sep = " ",
    extra = "merge"
  ) %>% 
  mutate(
    AQI = as.numeric(AQI),
    AQI_Cat = AQI_Cat %>% factor(levels = c("Good", "Moderate","Moderately Unhealthy","Unhealthy","Very Unhealthy","Hazardous"))
  )

smc_pm25_voronoi <-
  smc_sensors_clean %>%
  filter(location_type == "outside") %>% 
  st_union() %>% 
  st_voronoi() %>% 
  st_cast() %>% 
  st_as_sf() %>% 
  st_intersection(.,st_union(counties("CA") %>% filter(NAME == "San Mateo") %>% st_transform(4326))) %>% 
  st_join(smc_sensors_clean %>% filter(location_type == "outside"))

ggplot(smc_pm25_voronoi) + geom_sf()  

# smc_places <- places("CA", cb = T) %>%
#  st_centroid() %>%
#  .[counties("CA") %>% filter(NAME == "San Mateo"),] %>%
#   st_drop_geometry() %>%
#   left_join(places("CA", cb = T) %>% select(PLACEFP)) %>%
#   st_as_sf() %>% 
#   filter(NAME %in% c("Belmont", "East Palo Alto", "Foster City", "Redwood City", "San Mateo", "South San Francisco"))
# 
# saveRDS(smc_places, "smc_places.rds")

smc_places <- readRDS("smc_places.rds")

smc_sensors_clean_outside <- smc_sensors_clean %>% 
  filter(location_type == "outside") %>% 
  .[smc_places %>% st_transform(4326), ]

# smc_cbgs <- block_groups("CA","San Mateo", cb = T) %>% 
#   st_transform(4326)
# saveRDS(smc_cbgs, "smc_cbgs.rds")

smc_cbgs <- readRDS("smc_cbgs.rds")

smc_cbg_places <- smc_cbgs %>% 
  .[smc_places %>% st_transform(4326),]

smc_pm25_voronoi_cbg <-
  smc_pm25_voronoi %>% 
  st_intersection(smc_cbg_places) %>% 
  st_make_valid() %>% 
  mutate(
    area = st_area(.) %>% as.numeric()
  ) %>% 
  st_drop_geometry() %>% 
  group_by(GEOID) %>% 
  summarize(
    PM25 = weighted.mean(PM25, area, na.rm = T)
  ) %>% 
  left_join(smc_cbg_places %>% dplyr::select(GEOID)) %>% 
  st_as_sf()


## getting purple air data by week
# ssf_boundary <- places("CA", cb = T) %>% 
#   filter(NAME == "South San Francisco") %>% 
#   st_transform(4326)
# 
# ssf_sensors <- smc_sensors_clean %>% 
#   .[ssf_boundary,]
# 
# week_start <- c("01", "08","15", "22")
# 
# sensor_daily_ssf <- week_start %>% 
#    map_dfr(function(week_start){
# 
#     start <- paste0("2022-02-", week_start, "%2000:08:00")
#     
#     week_end <- as.character(as.numeric(week_start) + 6) %>% 
#         str_pad(2, side = c("left"), pad = "0")
#     
#     end <- paste0("2022-02-", week_end, "%2000:08:00")
# 
#     print(start)
#     print(end)
#     
#     sensor_data <- 
#       1:nrow(ssf_sensors) %>% 
#       map_dfr(function(row){
#       
#       print(paste0(row,". ",ssf_sensors[row,]$sensor_index))
#       
#       a1 <- read_csv(paste0(
#         "https://api.thingspeak.com/channels/",
#         ssf_sensors[row,]$primary_id_a,
#         "/feeds.csv?api_key=",
#         ssf_sensors[row,]$primary_key_a,
#         "&average=1440&round=3&start=",start,
#         "&end=", end, 
#         "&timezone=America/Los_Angeles"
#       ), show_col_types = F) %>% 
#         set_names(c("created_at","PM1.0_CF_1_ug/m3_A","PM2.5_CF_1_ug/m3_A","PM10.0_CF_1_ug/m3_A","Uptime_Minutes_A","RSSI_dbm_A","Temperature_F_A","Humidity_%_A","PM2.5_CF_ATM_ug/m3_A")
#       ) %>% 
#     transmute(
#       date = as.Date(created_at),
#       ID = as.numeric(ssf_sensors[row,]$sensor_index),
#       Location = ssf_sensors[row,]$location_type,
#       PM25 = 0.524*as.numeric(`PM2.5_CF_1_ug/m3_A`) - 0.0852*as.numeric(`Humidity_%_A`) + 5.72
#     )
#           
#     }) %>% 
#       group_by(date, Location) %>% 
#       summarize(
#         PM25 = mean(PM25, na.rm = T)
#       ) %>% 
#       mutate(
#         city = "South San Francisco"
#       )
#   
#     return(sensor_data)
# })
# 
# full_sensor_ssf <- sensor_daily_ssf %>% filter(Location %in% c("outside"))
# full_sensor_epa <- readRDS("/Users/Chris/Documents/GitHub/chriscobedo.github.io/Winter/sensors/epa_sensor_data.rds")
# full_sensor_fc <- readRDS("/Users/Chris/Documents/GitHub/chriscobedo.github.io/Winter/sensors/fc_sensor_data.rds")
# full_sensor_belmont <- readRDS("/Users/Chris/Documents/GitHub/chriscobedo.github.io/Winter/sensors/feb_daily_belmont_data.rds")
# full_sensor_rwc <- readRDS("/Users/Chris/Documents/GitHub/chriscobedo.github.io/Winter/sensors/rwc_outdoor_weighted.rds")
# full_sensor_sm <- readRDS(
#   "/Users/Chris/Documents/GitHub/chriscobedo.github.io/Winter/sensors/sm_outdoor_weighted.rds"
#   ) %>% 
#   mutate(
#     city = "San Mateo"
#   )
# 
# daily_outdoor_sensor_combined <- full_sensor_belmont %>%
#   bind_rows(full_sensor_epa, full_sensor_fc, full_sensor_rwc, full_sensor_sm, full_sensor_ssf)
# 
# saveRDS(daily_outdoor_sensor_combined,"daily_outdoor_sensor_combined.rds")

daily_outdoor_sensor_combined <- readRDS("daily_outdoor_sensor_combined.rds")



full_sensors <- daily_outdoor_sensor_combined %>% 
  left_join(smc_places, by = c("city" = "NAME")) %>% 
  st_as_sf()

mapview(full_sensors)
```

Inputs {.sidebar}
-------------------------------------

```{r}
selectInput(
  inputId = "city", 
  label = "Jurisdiction:",
  choices = c("", smc_places$NAME), 
  ## selected = "East Palo Alto"
)
```

Column
-------------------------------------

### Plot

```{r}
plotlyOutput("plot")
```

```{r, context = "server"}
observeEvent(input$city, {
  
  chart <- daily_outdoor_sensor_combined %>% 
    filter(city == input$city) %>% 
    ggplot(
      aes(
        x = date,
        y = PM25
      )
    ) +
    geom_point(
    ) +
    geom_line(
    ) +
    labs(
      x = "",
      y = "PM2.5",
      title = 
        paste0("Daily Average PM2.5 for ", input$city),
      color = "Year"
    ) + 
    theme(legend.position = "bottom")
  
  output$plot <- renderPlotly({
    chart %>% 
      ggplotly() %>% 
      config(displayModeBar = F)
  })
  
})
```

Column
-------------------------------------

### Map

```{r}
leafletOutput("map")
```

```{r, context = "server"}
pm25_pal <- colorNumeric(
  palette = "RdYlGn",
  reverse = T,
  domain = c(
    smc_pm25_voronoi_cbg$PM25,
    smc_sensors_clean_outside$PM25
  )
)
  
output$map <- renderLeaflet({
  leaflet() %>% 
  addProviderTiles(provider = providers$CartoDB.Positron) %>% 
  addPolygons(
    data = smc_pm25_voronoi_cbg,
    fillColor = ~pm25_pal(PM25),
    fillOpacity = 0.5,
    color = "white",
    weight = 0.5,
    label = ~PM25,
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>% 
  addCircleMarkers(
    data = smc_sensors_clean_outside,
    fillColor = ~pm25_pal(PM25),
    fillOpacity = 1,
    color = "black",
    weight = 0.5,
    radius = 5,
    label = ~PM25
  ) %>% 
  addLegend(
    pal = pm25_pal,
    values = c(
      smc_pm25_voronoi_cbg$PM25,
      smc_sensors_clean_outside$PM25
    ),
    title = "Weekly Average PM2.5<br>for 3/16 by CBG"
  )
})
```

```{r, context = "server"}
observeEvent(input$city, {
  
  selected <- smc_places %>% 
    filter(NAME == input$city)
  
  leafletProxy("map") %>% 
    removeShape("selected") %>% 
    addPolygons(
      data = selected,
      fill = F,
      color = "black",
      weight = 2,
      opacity = 1,
      layerId = "selected"
    )
  
})
```

















