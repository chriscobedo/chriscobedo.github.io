---
title: "A1_ChrisEscobedo"
author: "Chris"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: html_document  
---

```{r, include = F}
knitr::opts_chunk$set(echo = F, warnings = F, message = F)
```

```{r}
library(tidyverse)
library(mapview)
library(tigris)
library(sf)
library(leaflet)
library(esri2sf)
library(tidycensus)
library(censusapi)

Sys.setenv(CENSUS_KEY="c7ce771b506b13ca6875d12a179606f8087fa381")

census_api_key("c8aa67e4086b4b5ce3a8717f59faa9a28f611dab")

acs_vars_2019_5yr <-
  listCensusMetadata(
    name = "2019/acs/acs5/subject",
    type = "variables"
  )
```

Intro

### Housing Burden

For the purpose of this assesment, housing burden has been defined as using by a threshold of 30% of one's household income. Those who spend more than 30% of income on housing are considered to be housing burdened, while those spend less are considered to not be housing burdened. Although this is an arbitrarily chosen cutoff, it is useful to use to get a quick understanding of those who may struggle to pay for housing in the area.

That being said, it is important to note there may be times when this makes the findings less accurate. For extremely high income earners, using more than 30% on housing may not matter to their living situation if they have plenty of disposable income leftover. Furthermore, some families that use 29% of their income on housing may be struggling financially, but will not be counted in this measure of housing burden because of the arbitrary cutoff. 


```{r}
neighboring_counties <- 
  counties("CA", cb = T, progress_bar = F) %>% 
  filter(NAME %in% c("San Mateo","Santa Clara"))

ca_places <- 
  places("CA", cb = T, progress_bar = FALSE) 

neighboring_places <- 
  ca_places %>% 
  st_centroid() %>% 
  .[neighboring_counties, ] %>% 
  st_drop_geometry() %>% 
  left_join(ca_places %>% select(GEOID)) %>% 
  st_as_sf() 

EPA_boundary <- 
  places("CA", cb = T, progress_bar = FALSE) %>% 
  filter(NAME == "East Palo Alto")

housing_burden_neighboring_counties <- getCensus(
  name = "acs/acs5/subject",
  vintage = 2019,
  region = "place:*",
  regionin = "state:06",
  vars = paste0("S2503_C0", c(
  "3_025E","3_026E", "3_027E", "3_028E", "3_029E","3_030E", "3_031E", "3_032E", "3_033E", "3_034E", "3_035E", "3_036E", "3_037E", "3_038E", "3_039E", "3_040E", "3_041E", "3_042E", "3_043E", "3_044E", "3_045E", "3_046E", "5_025E","5_026E", "5_027E", "5_028E", "5_029E","5_030E", "5_031E", "5_032E", "5_033E", "5_034E", "5_035E", "5_036E", "5_037E", "5_038E", "5_039E", "5_040E", "5_041E", "5_042E", "5_043E", "5_044E", "5_045E", "5_046E")
  )
) %>% 
  filter(place %in% neighboring_places$PLACEFP) %>%
  select(!c(state,place) & !ends_with(c("EA","MA","M"))) %>%
  pivot_longer(
    ends_with("E"),
    names_to = "name",
    values_to = "estimate"
  ) %>%
  left_join(
    acs_vars_2019_5yr %>% 
      select(name, label)
    ) %>% 
  select(-name) %>% 
  separate(
    label,
    into = c(NA,"occupation",NA, NA,"income", "burden"),
    sep = "!!"
  ) %>% 
  filter(!is.na(burden)) %>% 
  mutate(
    burden = if_else(burden == "20 to 29 percent" | burden == "Less than 20 percent", 
              "less than 30 percent", 
              burden)
  ) %>% 
  group_by(income, occupation, burden) %>% 
  summarize(estimate = sum(estimate))

housing_burden_epa <- getCensus(
  name = "acs/acs5/subject",
  vintage = 2019,
  region = "place:20956",
  regionin = "state:06",
  vars = paste0("S2503_C0", c(
  "3_025E","3_026E", "3_027E", "3_028E", "3_029E","3_030E", "3_031E", "3_032E", "3_033E", "3_034E", "3_035E", "3_036E", "3_037E", "3_038E", "3_039E", "3_040E", "3_041E", "3_042E", "3_043E", "3_044E", "3_045E", "3_046E", "5_025E","5_026E", "5_027E", "5_028E", "5_029E","5_030E", "5_031E", "5_032E", "5_033E", "5_034E", "5_035E", "5_036E", "5_037E", "5_038E", "5_039E", "5_040E", "5_041E", "5_042E", "5_043E", "5_044E", "5_045E", "5_046E")
  )
) %>% 
  filter(place %in% neighboring_places$PLACEFP) %>%
  select(!c(state,place) & !ends_with(c("EA","MA","M"))) %>%
  pivot_longer(
    ends_with("E"),
    names_to = "name",
    values_to = "estimate"
  ) %>%
  left_join(
    acs_vars_2019_5yr %>% 
      select(name, label)
    ) %>% 
  select(-name) %>% 
  separate(
    label,
    into = c(NA,"occupation",NA, NA,"income", "burden"),
    sep = "!!"
  ) %>% 
  filter(!is.na(burden)) %>% 
  mutate(
    burden = if_else(burden == "20 to 29 percent" | burden == "Less than 20 percent", 
              "less than 30 percent", 
              burden)
  ) %>% 
  group_by(income, occupation, burden) %>% 
  summarize(estimate = sum(estimate))

housing_burden_epa_reordered <- housing_burden_epa %>% 
  filter(income == "Less than $20,000") %>% 
  rbind(housing_burden_epa) %>% 
  .[-c(21, 22, 23, 24), ]



```

plotting ACS data
```{r}
burden_plot_epa <- housing_burden_epa_reordered %>% 
  ggplot() +
  geom_bar(
    aes(
      x = income %>% factor(levels = unique(housing_burden_epa_reordered$income)),
      y = estimate,
      fill = burden,
    ),
    stat = "identity",
    position = "stack"
  ) +
  labs(
    x = "Household Income",
    y = "Number of Households",
    title = "East Palo Alto housing burden by income and renter/owner status",
    fill = "% of Income spent on housing"
  ) +
  coord_flip() +
  facet_grid(. ~ occupation)

burden_plot_epa

```



Parcel Data

```{r}
epa_zoning <- esri2sf("https://services8.arcgis.com/0IC8hha3hgQkmGoa/arcgis/rest/services/EastPaloAltoZoning_2021_WFL1/FeatureServer/1")

smc_exemption <- read_csv("https://datahub.smcgov.org/api/views/pmvw-bs84/rows.csv?accessType=DOWNLOAD")

epa_exemption <- smc_exemption %>% 
  mutate(
    APN = `Parcel Number` %>% 
      str_replace_all("-","")
  ) %>% 
  filter(APN %in% epa_zoning$APN) %>% 
  left_join(epa_zoning) %>% 
  st_as_sf() %>% 
  filter(New_Zone == "R-LD")

leaflet() %>% 
  addProviderTiles(provider = providers$CartoDB.Positron) %>% 
  addPolygons(
    data = epa_exemption %>% 
      filter(`Fiscal Year` == "2018/2019"),
    fillColor = "yellow",
    color = "black",
    weight = 0.5
  ) %>% 
  addPolygons(
    data = epa_exemption %>% 
      filter(Exemption %in% c(5600,7000)),
    fillColor = "blue",
    color = "black",
    weight = 0.5,
    fillOpacity = 1
  )

```


