---
title: "Chapter_3"
author: "Chris"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: html_document  
---

```{r, include = F}
knitr::opts_chunk$set(echo = F, warnings = F, message = F)
```

```{r}
library(tidyverse)
library(sf)
library(tigris)
library(censusapi)
library(mapview)
library(leaflet)
library(mapboxapi)
library(readxl)

Sys.setenv(CENSUS_KEY="c7ce771b506b13ca6875d12a179606f8087fa381")

mb_access_token("pk.eyJ1IjoiY2hyaXNjb2JlZG8iLCJhIjoiY2t5dWpuOWQwMW5yeTJ1bzdkb2xwNDhzdCJ9.bvKU0wmr5ZptXvmo6vxRkQ", install = T)

path <- "/Volumes/GoogleDrive/Shared drives/SFBI/Data Library/NHTS/nhts17-caltrans-tsdc-download/"
```

Class:

```{r}
pois <- st_read("/Volumes/GoogleDrive/Shared drives/SFBI/Data Library/OSM/gis_osm_pois_a_free_1.shp")

## get counts
pois_summary <- pois %>% 
  st_drop_geometry() %>% 
  group_by(fclass) %>% 
  count() %>% 
  arrange(desc(n))

## Getting geography - transforming to pois coordinate
smc_boundary <- counties("CA") %>% 
  filter(NAME == "San Mateo") %>% 
  st_transform(st_crs(pois))

## filtering to geography
smc_pois <- pois %>% 
  .[smc_boundary, ] %>% 
  rename(amenity = fclass)

mapview(smc_pois, zcol = "amenity")

## filter to important amenities
pois_filter <- pois %>% 
  rename(amenity = fclass) %>% 
  filter(amenity %in% c(
    "park",
    "convenience",
    "restaurant",
    "supermarket",
    "library"
  ))

mapview(smc_pois_filter, zcol = "amenity")

## get block groups
smc_cbgs <- block_groups("CA","San Mateo")

## get North Fair Oaks
nfo_boundary <- places("CA") %>% 
  filter(NAME == "North Fair Oaks")

## filter block group data to NFO
nfo_cbgs <- smc_cbgs %>% 
  st_centroid() %>% 
  .[nfo_boundary, ] %>% 
  st_drop_geometry() %>% 
  left_join(smc_cbgs %>% select(GEOID)) %>% 
  st_as_sf()

mapview(nfo_cbgs)

isochrone <- mb_isochrone(
  nfo_cbgs,
  profile = "walking",
  time = c(5,10,15)
)

## getting isochrones
isochrone <- mb_isochrone(
  nfo_cbgs,
  profile = "walking",
  time = c(5,10,15)
)

isochrone[1:3,] %>% mapview()

## important to save so you dont rerun this and use up credits
saveRDS(isochrone, "saveSomewhere.RDS")

## create master data sheet- all isochrones 
access_raw <- isochrone %>% 
  st_make_valid() %>% 
  st_join(smc_pois_filter) %>% 
  st_drop_geometry() %>% 
  filter(!is.na(osm_id))
```

next step -> making ranks

```{r}
amenity_preference <- data.frame(
  amenity = c("park", "convenience", "restaurant", "supermarket", "library"),
  amenity_value = c(
    0.8,
    0.6,
    0.25,
    1,
    0.7
  ),
  amenity_quantity = c(
    2,
    5,
    30,
    1,
    1
  )
) %>% 
  mutate(
    amenity_decay = -log(0.5)/amenity_quantity
  )
```



textbook: 

3.1
```{r}
survey_household <- read_csv(paste0(path,"survey_household.csv"))

survey_person <- read.csv(paste0(path,"survey_person.csv")) 

survey_trip <- read_csv(paste0(path,"survey_trip.csv"))

survey_person_weights_7day <- read_csv(paste0(path,"survey_person_weights_7day.csv"))

nhts_lookup <- read_excel(
  paste0(path,"data_elements.xlsx"), 
  sheet = "Value Lookup"
)

## link weights to survey_person
person_weights <-
  survey_person %>% 
  left_join(
    survey_person_weights_7day %>% 
      select(
        sampno,
        perno,
        wttrdfin
      ),
    by = c("sampno","perno")
  )

## get geographies for bay area of CBSA's
bay_county_names <-
  c(
    "Alameda",
    "Contra Costa",
    "Marin",
    "Napa",
    "San Francisco",
    "San Mateo",
    "Santa Clara",
    "Solano",
    "Sonoma"
  )

bay_counties <-
  counties("CA", cb = T, progress_bar = F) %>%
  filter(NAME %in% bay_county_names)

cbsas <- core_based_statistical_areas(cb = T, progress_bar = F)

bay_cbsas <-
  cbsas %>%
  .[bay_counties %>% st_centroid(), ]

## map
leaflet(bay_cbsas) %>% 
  addTiles() %>% 
  addPolygons(
    label = ~paste0(GEOID,": ",NAME)
  )
```

fully combined dataset
```{r}
bay_trips <-
  survey_trip %>% 
  left_join(
    survey_person,
    by = c("sampno","perno")
  ) %>% 
  left_join(
    survey_person_weights_7day %>% 
      select(
        sampno,
        perno,
        wttrdfin
      ),
    by = c("sampno","perno")
  ) %>% 
  left_join(
    survey_household %>% select(
      sampno,
      hh_cbsa
    )
  ) %>% 
  filter(hh_cbsa %in% bay_cbsas$GEOID)

## look at trip purpose
purpose_lookup <-
  nhts_lookup %>% 
  filter(NAME == "WHYTO") %>% 
  select(VALUE, LABEL) %>% 
  mutate(
    VALUE = as.numeric(VALUE),
    LABEL = factor(LABEL, levels = LABEL)
  )

## look at mode
mode_lookup <-
  nhts_lookup %>% 
  filter(NAME == "TRPTRANS") %>% 
  select(VALUE, LABEL) %>% 
  mutate(
    VALUE = as.numeric(VALUE),
    LABEL = factor(LABEL, levels = LABEL)
  )
```

combining trip data
```{r}
bay_trips_summary_whyto <-
  bay_trips %>% 
  left_join(
    purpose_lookup,
    by = c("whyto" = "VALUE")
  ) %>% 
  rename(purpose_label = LABEL) %>% 
  left_join(
    mode_lookup,
    by = c("trptrans" = "VALUE")
  ) %>% 
  rename(mode_label = LABEL) %>% 
  mutate(
    tripmiles_wt =
      trpmiles * wttrdfin
  ) %>% 
  group_by(
    purpose_label,
    mode_label
  ) %>% 
  summarize(
    tripmiles_wt = sum(tripmiles_wt),
    trips = sum(wttrdfin)
  ) %>% 
  ungroup()

bay_trips_summary_whyfrom <-
  bay_trips %>% 
  left_join(
    purpose_lookup,
    by = c("whyfrom" = "VALUE")
  ) %>% 
  rename(purpose_label = LABEL) %>% 
  left_join(
    mode_lookup,
    by = c("trptrans" = "VALUE")
  ) %>% 
  rename(mode_label = LABEL) %>% 
  mutate(
    tripmiles_wt =
      trpmiles * wttrdfin
  ) %>% 
  group_by(
    purpose_label,
    mode_label
  ) %>% 
  summarize(
    tripmiles_wt = sum(tripmiles_wt),
    trips = sum(wttrdfin)
  ) %>% 
  ungroup()

bay_trips_summary <-
  rbind(
    bay_trips_summary_whyto,
    bay_trips_summary_whyfrom
  ) %>% 
  group_by(purpose_label, mode_label) %>% 
  summarize(
    tripmiles_wt = mean(tripmiles_wt, na.rm = T),
    trips = mean(trips, na.rm = T)
  ) %>% 
  ungroup()

## if you wanted data wide
bay_trips_summary_wide <-
  bay_trips_summary %>% 
  pivot_wider(
    -tripmiles_wt,
    names_from = mode_label,
    values_from = trips
  ) %>% 
  column_to_rownames("purpose_label")

## plot with refinements 
bay_trips_summary %>% 
  filter(
    trips > 1e6/2,
    !purpose_label %in% c("1. Regular home activities (chores, sleep)", "2. Work from home (paid)")
  ) %>% 
  ggplot(
    aes(
      x = purpose_label,
      y = reorder(mode_label, desc(mode_label))
    )
  ) +
  geom_tile(
    aes(fill = trips)
  ) + 
  geom_text(
    aes(label = (trips/1e6) %>% round()), 
    color = "white",
    size = 2
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.text.y = element_text(angle = 45, hjust = 1)
  ) + 
  labs(
    x = "Trip Purpose",
    y = "Trip Mode",
    title = "Bay Area travel patterns, 2017",
    subtitle = "Values are millions of trips per year. Trips are allocated based on 50/50 split\nof origin/destination purpose. Home-allocated trips removed."
  )

## percent plot
bay_trips_summary %>% 
  filter(
    !purpose_label %in% c("1. Regular home activities (chores, sleep)", "2. Work from home (paid)")
  ) %>% 
  mutate(
    trips_perc = trips/sum(trips)
  ) %>% 
  filter(
    trips_perc > 0.005
  ) %>% 
  ggplot(
    aes(
      x = purpose_label,
      y = reorder(mode_label, desc(mode_label))
    )
  ) +
  geom_tile(
    aes(fill = trips_perc)
  ) + 
  geom_text(
    aes(label = (trips_perc*100) %>% round()), 
    color = "white"
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.text.y = element_text(angle = 45, hjust = 1)
  ) + 
  labs(
    x = "Trip Purpose",
    y = "Trip Mode",
    title = "Bay Area travel patterns, 2017",
    subtitle = "Values are percent of trips per year. Trips are allocated based on 50/50 split\nof origin/destination purpose. Home-allocated trips removed."
  )

## trip miles plot - planes filtered out
bay_trips_summary %>% 
  filter(
    mode_label != "Airplane",
    !purpose_label %in% c("1. Regular home activities (chores, sleep)", "2. Work from home (paid)")
  ) %>% 
  mutate(
    tripmiles_perc = tripmiles_wt/sum(tripmiles_wt)
  ) %>%
  filter(
    tripmiles_perc > 0.005
  ) %>%
  ggplot(
    aes(
      x = purpose_label,
      y = reorder(mode_label, desc(mode_label))
    )
  ) +
  geom_tile(
    aes(fill = tripmiles_perc)
  ) + 
  geom_text(
    aes(label = (tripmiles_perc*100) %>% round()), 
    color = "white"
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.text.y = element_text(angle = 45, hjust = 1)
  ) + 
  labs(
    x = "Trip Destination",
    y = "Trip Mode",
    title = "Bay Area travel patterns, 2017",
    subtitle = "Values are percent of trip miles per year. Trips are allocated based on 50/50 split\nof origin/destination purpose. Home-allocated trips removed."
  )
```

3.4

```{r}

```








