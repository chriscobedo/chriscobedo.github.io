---
title: "ChrisEscobedo_A3"
author: "Chris"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: html_document
---

```{r, include = F}
knitr::opts_chunk$set(echo = F, warnings = F, message = F)
```

```{r, warning=FALSE}
library(lehdr)
library(tidyverse)
library(tigris)
library(sf)
library(leaflet)
library(censusapi)
library(mapboxapi)

Sys.setenv(CENSUS_KEY="c7ce771b506b13ca6875d12a179606f8087fa381")
```

## Introduction

This analysis will focus on the zip code area of 94804, which is in the South of Richmond. This area is intersting to analyze, as it has much lower median income and is much more diverse than many of the surrounding. This might imply that more of the members of this community will commute to work, as they are not able to afford areas closer to economic opportunities. It also will be interesting to look at the energy usage, given homes and buildings may be older and not as likely to be retrofitted because of the lack of capital for such upgrades. This context might provide valuable insight into how funding and support for upgrades in communities like this and affordable housing upgrades closer to job hubs could make large differences for reaching our GHG and equity goals as a state.

## Vehicle Emissions Analysis

To create the analysis of vehicle emissions, this report uses data from LODES for trip data. It uses data from 2013 to 2019 to calculate commute emissions for the zip code area in the south of Richmond as an origin and as a destination.

```{r, warning = FALSE}
# zctas <- zctas()
# 
# zip <- zctas %>% 
#   filter(GEOID10 == 94804)
# 
# blocks <- blocks("CA")
# 
# zip_blocks <- blocks %>% 
#   st_centroid() %>% 
#   .[zip, ]
# 
# saveRDS(zip_blocks, "zip_blocks.rds")

zip_blocks <- readRDS("zip_blocks.rds")

## compiling OD LODES data from 2013-2019
# full_zip_od <- 2013:2019 %>% 
#   map_dfr(function(year){
#     
#     print(year)
#     
#     temp <- read_csv(paste0("/Volumes/GoogleDrive/Shared drives/SFBI/Data Library/LODES/ca_od_main_JT01_", year, ".csv.gz")) %>% 
#       filter(
#         h_geocode %in% zip_blocks$GEOID10 |
#           w_geocode %in% zip_blocks$GEOID10
#       ) %>% 
#       mutate(year = year)
#     
#     saveRDS(temp, paste0("temp_od_", year, ".rds"))
#     
#     return(temp)
#     
#   })
# 
# saveRDS(full_zip_od, "full_zip_od.rds")

full_zip_od <- readRDS("full_zip_od.rds")

## Removing "negligible trips" - e.g. trips that went from one zip code to the same zip code
full_zip_od_clean <- full_zip_od %>% 
  select(-createdate) %>% 
  filter(!(
    h_geocode %in% zip_blocks$GEOID10 &
      w_geocode %in% zip_blocks$GEOID10
  )) %>% 
  mutate(
    direction = ifelse(
      h_geocode %in% zip_blocks$GEOID10,
      "outbound",
      "inbound"
    )
  )
```

*This analysis assumes that commute data originating and ending in the same census block would be negligible, especially when compared to trips crossing boundaries of census block boundaries. Because this analysis groups trip origin and destination points by census block, the commute data that is within a single census block is disregarded and treated as zero. Of course, this will remove a non-zero number of trips and emissions from the final analysis. The assumption is that this omission will not likely constitute a large enough amount of emissions that the advantages of grouping by the census block to simplify the analysis will outweigh the disadvantages.*



```{r, warning = FALSE}
full_zip_od_routing <- full_zip_od_clean %>%
  mutate(
    origin = ifelse(
      direction == "inbound",
      h_geocode,
      w_geocode
    ),
    cbg = origin %>% substr(1,12),
    tract = origin %>% substr(1,11)
  ) %>%
  filter(!duplicated(cbg))

# ca_tracts <- tracts("CA")
# 
# zip_od_origin <-
#   full_zip_od_routing %>% 
#   select(tract) %>% 
#   left_join(ca_tracts %>% select(tract = GEOID)) %>% 
#   st_as_sf() %>% 
#   st_centroid() %>% 
#   st_coordinates()
# 
# zip_od_destination <-
#   zip %>% 
#   st_centroid() %>% 
#   st_coordinates()
#   
# zip_od_route <- 
#   1:ceiling(nrow(zip_od_origin)/1000) %>% 
#   map_dfr(function(y){
#     
#     print(y)
#     
#     temp <- (y * 1000 - 999) : pmin(y * 1000, nrow(zip_od_origin)) %>% 
#       map_dfr(function(x){
#         tryCatch(
#           mb_directions(
#             origin = zip_od_origin[x, ],
#             destination = zip_od_destination,
#             profile = "driving-traffic"
#           ) %>% 
#             mutate(id = x),
#           error = function(e){
#             data.frame(id = x)
#           }
#         )
#       }) %>% 
#       st_as_sf()
#       
#       saveRDS(temp, paste0("temp",y,".rds"))
#       
#       return(temp)
#     
#   })
# 
# saveRDS(zip_od_route, "zip_od_route.rds")

zip_od_route <- readRDS("zip_od_route.rds")

```


```{r}
full_zip_od_routed <- full_zip_od_routing %>% 
  cbind(zip_od_route)

full_zip_od_final <- full_zip_od_clean %>% 
  mutate(
    origin = ifelse(
      direction == "inbound",
      h_geocode,
      w_geocode
    ),
    cbg = substr(origin, 1, 12)
  ) %>% 
  left_join(
    full_zip_od_routed %>% 
      select(cbg, duration, distance)
  ) %>% 
  mutate(
    visits = S000 * 261
  )
```


```{r, warning=FALSE}
# acs_vars_2019_5yr_all <-
#   listCensusMetadata(
#     name = "2019/acs/acs5/",
#     type = "variables"
#   )
# 
# saveRDS(acs_vars_2019_5yr_all, "acs_vars_2019_5yr_all.csv")

acs_vars_2019_5yr_all <- readRDS("acs_vars_2019_5yr_all.csv")

travel_time_mode <-
  counties("CA", cb = T, progress_bar = F) %>%
  pull(COUNTYFP) %>% 
  map_dfr(function(x){
    getCensus(
      name = "acs/acs5",
      vintage = 2019,
      region = "block group:*",
      regionin = paste0("state:06+county:", x),
      vars = "group(B08134)"
    )
  }) 

 travel_time_mode_clean <- travel_time_mode %>% 
  mutate(
    cbg =
      paste0(state,county,tract,block_group)
  ) %>%
  filter(cbg %in% full_zip_od_final$cbg) %>% 
  select(!c(GEO_ID,state,county,tract,block_group,NAME) & !ends_with(c("EA","MA","M"))) %>%
  pivot_longer(
    ends_with("E"),
    names_to = "variable",
    values_to = "estimate"
  ) %>%
  left_join(
    acs_vars_2019_5yr_all %>% 
      select(name, label), 
    by = c("variable" = "name")
  ) %>% 
  select(-variable) %>% 
  separate(
    label,
    into = c(NA, NA, "total", "mode", "carpool", "time"),
    sep = "!!"
  ) %>% 
  mutate(
    mode = case_when(
      total %in% c(
        "Less than 10 minutes",
        "10 to 14 minutes",
        "15 to 19 minutes",
        "20 to 24 minutes",
        "25 to 29 minutes",
        "30 to 34 minutes",
        "35 to 44 minutes",
        "45 to 59 minutes",
        "60 or more minutes"
      ) ~ "Total",
      mode == "Drove alone:" ~ mode,
      carpool %in% c(
        "In 2-person carpool:",
        "In 3-or-more-person carpool:"
      ) ~ carpool
    ),
    time = case_when(
      mode == "Total" ~ total,
      mode == "Drove alone:" ~ carpool,
      mode == carpool ~ time
    )
  ) %>% 
  filter(!is.na(time)) %>% 
  select(-total, -carpool) %>% 
  pivot_wider(
    names_from = mode,
    values_from = estimate
  ) %>% 
  mutate(
    perc_veh1 = `Drove alone:`/Total,
    perc_veh2 = `In 2-person carpool:`/Total,
    perc_veh3 = `In 3-or-more-person carpool:`/Total
  )

work_trips_richmond <-
  full_zip_od_final %>% 
  mutate(
    time = case_when(
      duration < 10 ~ "Less than 10 minutes",
      duration < 15 ~ "10 to 14 minutes",
      duration < 20 ~ "15 to 19 minutes",
      duration < 25 ~ "20 to 24 minutes",
      duration < 30 ~ "25 to 29 minutes",
      duration < 35 ~ "30 to 34 minutes",
      duration < 45 ~ "35 to 44 minutes",
      duration < 60 ~ "45 to 59 minutes",
      TRUE ~ "60 or more minutes"
    )
  ) %>% 
  left_join(
    travel_time_mode_clean %>% 
      select(
        cbg,
        time,
        perc_veh1,
        perc_veh2,
        perc_veh3
      ),
    by = c("cbg", "time")
  ) %>% 
  mutate(
    vehicles = 
      visits * perc_veh1 + 
      visits * perc_veh2 / 2 +
      visits * perc_veh3 / 3,
    vmt = vehicles * distance * 2
  )
```

### Greenhouse Gas Emissions

Next we will use data from California Air Resources Board (CARB) Emission Factors (EMFAC) model. This model  includes emissions rates data, year by year.

```{r, warning = FALSE}
emfac <- 
  read_csv("EMFAC2021-range.csv", skip = 8) %>% 
  transmute(
    Year = `Calendar Year`,
    Category = `Vehicle Category`,
    Fuel_Type = Fuel,
    Percent_Trips = Trips/sum(Trips),
    Percent_Miles = `Total VMT`/sum(`Total VMT`),
    `MTCO2_Running_Exhaust` = CO2_RUNEX/`Total VMT`,
    `MTCO2_Start_Exhaust` = CO2_STREX/Trips
  )

work_trips_richmond_ghg <-
  emfac %>% 
  mutate(
    trips = Percent_Trips * sum(work_trips_richmond$visits, na.rm = T),
    vmt = Percent_Miles * sum(work_trips_richmond$vmt, na.rm = T),
    ghg = vmt*MTCO2_Running_Exhaust + trips*MTCO2_Start_Exhaust*2
  )
```

The cumulative amount of greenhouse gas emissions for vehicles entering or leaving the South Richmond zip code area from 20139-2019 is displayed below, in metric tonnes of CO2.

```{r}
sum(work_trips_richmond_ghg$ghg)
```

## Building Emissions Analysis

Next, we will conduct an analysis of building emissions for the same area, using PG&E electricity and gas data for the range of 2013 to 2019. 

```{r, include = FALSE, warning=FALSE}
pge_elec_emissions_factor <-
  data.frame(
    year = c(2013:2019),
    factor = c(427,435,405,294,210,206,2.68)
  )

pge_data <- 
  2013:2019 %>% 
  map_dfr(function(yr){
    
    print(yr)
    
    factor <- 
      pge_elec_emissions_factor %>% 
      filter(year == yr) %>% 
      pull(factor)
    
    1:4 %>% 
      map_dfr(function(quarter){
        
        print(quarter)
        
        c("Electric","Gas") %>% 
          map_dfr(function(type){
            
            print(type)
            
            filename <- 
              paste0(
                "pge/PGE_",
                yr,
                "_Q",
                quarter,
                "_",
                type,
                "UsageByZip.csv"
              )
            
            temp <- read_csv(filename)
            
            if(yr == 2017 & quarter == 4) {
              temp <- 
                temp %>% 
                filter(MONTH != 9)
            }
            
            if(yr == 2014 & quarter == 3 & type == "Gas"){
              temp <- temp %>% 
                mutate(
                  TOTALTHM = TotalTherms
                )
            }
            
            temp <-
              temp %>% 
              rename_all(toupper) %>% 
              mutate(
                TOTALKBTU = ifelse(
                  substr(CUSTOMERCLASS,1,1) == "E",
                  TOTALKWH * 3.412,
                  TOTALTHM * 99.976
                ),
                TOTALTCO2E = ifelse(
                  substr(CUSTOMERCLASS,1,1) == "E",
                  TOTALKWH/1000 * factor * 0.000453592,
                  TOTALTHM * 0.00531
                )
              ) %>% 
              select(
                ZIPCODE,
                YEAR,
                MONTH,
                CUSTOMERCLASS,
                TOTALKBTU,
                TOTALTCO2E,
                TOTALCUSTOMERS
              )
             
          })
        
      })
    
  })

richmond_pge_data <-
  pge_data %>% 
  filter(ZIPCODE %in% c("94804")) %>% 
  filter(CUSTOMERCLASS %in% c(
    "Elec- Commercial",
    "Elec- Residential",
    "Gas- Commercial",
    "Gas- Residential"
  )) %>% 
  mutate(
    ENERGYTYPE = CUSTOMERCLASS
  ) %>% 
  group_by(ZIPCODE, ENERGYTYPE, YEAR) %>% 
  summarize(
    TOTALKBTU = sum(TOTALKBTU, na.rm=T),
    TOTALTCO2E = sum(TOTALTCO2E, na.rm=T), 
    TOTALCUSTOMERS = mean(TOTALCUSTOMERS, na.rm=T)
  ) %>% 
  group_by(ENERGYTYPE, YEAR) %>%
  summarize(across(
    c(TOTALKBTU,TOTALTCO2E,TOTALCUSTOMERS),
    ~sum(.,na.rm=T)
  ))
```

### Graph of Building Emissions

Below is a graph of the total annual building emissions. The total emissions were estimated from the PG&E data, and normalized using population, jobs, and CDDs and HDDs.

```{r}
## population data

## job data
richmond_jobs <- 2013:2019 %>% 
  map_dfr(function(year){

    print(year)

    temp <- ca_od <- grab_lodes(
      state = "ca", 
      year = 2013, 
      lodes_type = "wac", 
      job_type = "JT01",
      state_part = "main", 
      agg_geo = "block"
    ) %>%
    filter(
      w_geocode %in% zip_blocks$GEOID10
    ) %>%
    mutate(
      year = year,
      jobs = C000
    ) %>% 
    select(year, w_geocode, jobs)

    saveRDS(temp, paste0("temp_jobs", year, ".rds"))

    return(temp)

  })


##normalized buildings emissions
richmond_pge_data_normalized <- richmond_pge_data %>% 
  ## left_join pop and jobs data to buildings per year
  mutate(
     ## normalize emissions 
  )

```


### Graph of total Greenhouse Gas Emissions 

Below is a graph that shows the total annual greenhouse gas emission for buildings and vehicles for the zip code area in the South of Richmond. It shows these amounts from 2013 to 2019.

```{r, warning=FALSE}


```



















