---
title: "ChrisEscobedo_A2"
author: "Chris"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: html_document  
---

```{r, include = F}
knitr::opts_chunk$set(echo = F, warnings = F, message = F)
```

```{r}
library(tidyverse)
library(sf)
library(tigris)
library(censusapi)
library(mapview)
library(leaflet)
library(mapboxapi)
library(readxl)

Sys.setenv(CENSUS_KEY="c7ce771b506b13ca6875d12a179606f8087fa381")

mb_access_token("pk.eyJ1IjoiY2hyaXNjb2JlZG8iLCJhIjoiY2t5dWpuOWQwMW5yeTJ1bzdkb2xwNDhzdCJ9.bvKU0wmr5ZptXvmo6vxRkQ", install = T)

path <- "/Volumes/GoogleDrive/Shared drives/SFBI/Data Library/NHTS/nhts17-caltrans-tsdc-download/"
```

## Location

I choose North Richmond as a place to perform the equity analysis on the city completeness score becasue North Richmond is a particularly diverse area of one of the most diverse cities. It was also designated as an opportunity zone, which means that there is likely to be a need for investment in the area.

```{r}
cc_blocks <- blocks("CA","Contra Costa")

richmond_boundary <- places("CA") %>% 
  filter(NAME == "North Richmond")

richmond_blocks <- cc_blocks %>% 
  st_centroid() %>% 
  .[richmond_boundary, ] %>% 
  st_drop_geometry() %>% 
  left_join(cc_blocks %>% select(GEOID10)) %>% 
  st_as_sf() %>% 
  filter(
    !(ALAND10 == 0)
  )

mapview(richmond_blocks)

## getting isochrones
# isochrones <- mb_isochrone(
#   richmond_blocks,
#   profile = "walking",
#   time = c(5,10,15)
# )  %>% 
#   mutate(
#     mode = "walking"
#   )
# 
# isochrones_cycling <- mb_isochrone(
#     richmond_blocks,
#     profile = "cycling",
#     time = c(5,10,15)
# )  %>% 
#   mutate(
#     mode = "biking"
#   )
# 
# isochrones_driving <- mb_isochrone(
#     richmond_blocks,
#     profile = "driving",
#     time = c(5,10,15)
# ) %>% 
#   mutate(
#     mode = "driving"
#   )
# 
# isochrones <- isochrones %>% 
#   rbind(isochrones_cycling) %>% 
#   rbind(isochrones_driving)
#
# saveRDS(isochrones, "richmond_isochrones.rds")

isochrones <- readRDS("richmond_isochrones.rds")

isochrones <- richmond_blocks %>% 
  mutate(
    id = 1:n()
  ) %>% 
  st_drop_geometry() %>% 
  select(id, GEOID10) %>% 
  left_join(isochrones) %>% 
  st_as_sf()

isochrones <- readRDS("richmond_isochrones.rds")

mapview(isochrones) + mapview(richmond_blocks)
```

## creating data with POIS

The POI data was filtered to only include those points of interest that were tagged as the following amenity types: "convenience", "restaurant", "supermarket", "hospital", "pharmacy", "school", "library", "community_centre", "arts_centre", "park".

Hospital was added as it is a critical part of health infrastructure and should be accessible to everyone in the community to improve equitable health outcomes. Pharmacies follow a similar line of reasoning, where they provide an important health resource for a community.

"School" was included because schools are an important piece of education and amount of schools and access to those schools in a community can directly impact education outcomes. Research has shown... 

Community Centers are an important part of civil life, as they give space for deliberation, gathering, and community building. It is not always considered critical infrastructure, but its potential benefit for psychological wellbeing are important.

#### Omissions 

I initially included several more POIS, but these were removed as there were none within the area for the North Richmond community, given this specific data set. OF course, this data could have been missing from the data set. For the purpose of this analysis, the following amenities were deemed important but were ultimately removed as they had no relevant data.

*"doctors", "dentist", "shelter", "bus_stop", "tram_stop"*


```{r}
## Getting POI data
# pois <- st_read("/Volumes/GoogleDrive/Shared drives/SFBI/Data Library/OSM/gis_osm_pois_a_free_1.shp")
# 
# pois_filter <- pois %>%
#   rename(amenity = fclass) %>%
#   filter(amenity %in% c(
#     "convenience",
#     "restaurant",
#     "supermarket",
#     "hospital",
#     "pharmacy",
#     "school",
#     "library",
#     "community_centre",
#     "arts_centre",
#     "park"
#    ))
# 
# saveRDS(pois_filter, "pois_filter.rds")

pois_filter <- readRDS("pois_filter.rds")

access_raw <- isochrones %>% 
  st_make_valid() %>% 
  st_join(pois_filter) %>% 
  st_drop_geometry() %>% 
  filter(!is.na(osm_id))

amenity_preference <- data.frame(
  amenity = c(
    "convenience",
    "restaurant",
    "supermarket",
    "hospital",
    "pharmacy",
    "school",
    "library",
    "community_centre",
    "arts_centre",
    "park"),
  amenity_value = c(
    0.1,
    0.8,
    1,
    1,
    0.6,
    0.9,
    0.3,
    0.6,
    0.4,
    0.9
  ),
  amenity_quantity = c(
    1,
    40,
    4,
    1,
    1,
    2,
    1,
    1,
    1,
    2
  )
) %>% 
  mutate(
    amenity_decay = -log(0.5)/amenity_quantity
  )

mode_preference <- data.frame(
  mode = c(
    "walking",
    "biking",
    "driving"
  ),
  mode_value = c(
    1,
    0.6,
    0.5
  )
) %>% 
  left_join(
    richmond_trips_summary %>% select(mean, mode)
) %>% 
  mutate(
    mode_reasonable = mean,
    mode_decay = -log(0.5)/mode_reasonable
  )
```


```{r}
path <- "/Volumes/GoogleDrive/Shared drives/SFBI/Data Library/NHTS/nhts17-caltrans-tsdc-download/"

survey_household <- read_csv(paste0(path,"survey_household.csv"))

survey_person <- read.csv(paste0(path,"survey_person.csv")) 

survey_trip <- read_csv(paste0(path,"survey_trip.csv"))

survey_person_weights_7day <- read_csv(paste0(path,"survey_person_weights_7day.csv"))

nhts_lookup <- read_excel(
  paste0(path,"data_elements.xlsx"), 
  sheet = "Value Lookup"
)

## link weights to survey_person
person_weights <-
  survey_person %>% 
  left_join(
    survey_person_weights_7day %>% 
      select(
        sampno,
        perno,
        wttrdfin
      ),
    by = c("sampno","perno")
  )

## get geographies for bay area of CBSA's
cc_county <-
  counties("CA", cb = T, progress_bar = F) %>%
  filter(NAME %in% "Contra Costa")

cbsas <- core_based_statistical_areas(cb = T, progress_bar = F)

richmond_cbsas <-
  cbsas %>%
  .[cc_county %>% st_centroid(), ]
```

To augment the score for the preference of mode of travel, I used the median length of trips using each mode to create a score for the "reasonable travel distance" for each mode. This will then be used to create the "decay" of value for POIs around North Richmond. Below is a map of the CBSA that was used to collect this trip data.

```{r, warning=F}
## map
leaflet(Richmond_cbsas) %>% 
  addTiles() %>% 
  addPolygons(
    label = ~paste0(GEOID,": ",NAME)
  )
```

```{r, include=F}
## combine dataset
richmond_trips <-
  survey_trip %>% 
  left_join(
    survey_person,
    by = c("sampno","perno")
  ) %>% 
  left_join(
    survey_person_weights_7day %>% 
      select(
        sampno,
        perno,
        wttrdfin
      ),
    by = c("sampno","perno")
  ) %>% 
  left_join(
    survey_household %>% select(
      sampno,
      hh_cbsa
    )
  ) %>% 
  filter(hh_cbsa %in% richmond_cbsas$GEOID)

## look at trip purpose
purpose_lookup <-
  nhts_lookup %>% 
  filter(NAME == "WHYTO") %>% 
  select(VALUE, LABEL) %>% 
  mutate(
    VALUE = as.numeric(VALUE),
    LABEL = factor(LABEL, levels = LABEL)
  )

## look at mode
mode_lookup <-
  nhts_lookup %>% 
  filter(NAME == "TRPTRANS") %>% 
  select(VALUE, LABEL) %>% 
  mutate(
    VALUE = as.numeric(VALUE),
    LABEL = factor(LABEL, levels = LABEL)
  )
```

Below is the final mean of each mode trip taken from the CBSA used to determine a "reasonable travel distance"

```{r, warning=F}
richmond_trips_summary <-
  richmond_trips %>% 
  left_join(
    purpose_lookup,
    by = c("whyto" = "VALUE")
  ) %>% 
  rename(purpose_label = LABEL) %>% 
  left_join(
    mode_lookup,
    by = c("trptrans" = "VALUE")
  ) %>% 
  rename(mode_label = LABEL) %>% 
  mutate(
    tripmiles_wt =
      trpmiles * wttrdfin
  ) %>% 
  group_by(
    purpose_label,
    mode_label
  ) %>% 
  summarize(
    tripmiles_wt = sum(tripmiles_wt),
    trips = sum(wttrdfin)
  ) %>% 
  mutate(
    mean = tripmiles_wt/trips
  ) %>% 
  ungroup() %>% 
  filter(mode_label == c("Car", "Walk", "Bicycle")) %>% 
  group_by(
    mode_label
  ) %>% 
  summarize(mean = mean(mean)
  ) %>% 
  mutate(
    mode = case_when(
      mode_label == "Walk" ~ "walking",
      mode_label == "Bicycle" ~ "biking",
      mode_label == "Car" ~ "driving"
    )
  )

richmond_trips_summary
```


## Baseline Hypothetical Completeness 

The following table shows the scores for each amenity in a hypothetical "complete city". This data will be used to measure against the reality of North Richmond.








