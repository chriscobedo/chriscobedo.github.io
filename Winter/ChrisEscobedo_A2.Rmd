---
title: "ChrisEscobedo_A2"
author: "Chris"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: html_document  
---

```{r, include = F}
knitr::opts_chunk$set(echo = F, warnings = F, message = F)
```

```{r}
library(tidyverse)
library(sf)
library(tigris)
library(censusapi)
library(mapview)
library(leaflet)
library(mapboxapi)
library(readxl)

Sys.setenv(CENSUS_KEY="c7ce771b506b13ca6875d12a179606f8087fa381")

mb_access_token("pk.eyJ1IjoiY2hyaXNjb2JlZG8iLCJhIjoiY2t5dWpuOWQwMW5yeTJ1bzdkb2xwNDhzdCJ9.bvKU0wmr5ZptXvmo6vxRkQ", install = T)

path <- "/Volumes/GoogleDrive/Shared drives/SFBI/Data Library/NHTS/nhts17-caltrans-tsdc-download/"
```

## Location

I choose North Richmond as a place to perform the equity analysis on the city completeness score becasue North Richmond is a particularly diverse area of one of the most diverse cities. It was also designated as an opportunity zone, which means that there is likely to be a need for investment in the area.

```{r}
cc_blocks <- blocks("CA","Contra Costa")

richmond_boundary <- places("CA") %>% 
  filter(NAME == "North Richmond")

richmond_blocks <- cc_blocks %>% 
  st_centroid() %>% 
  .[richmond_boundary, ] %>% 
  st_drop_geometry() %>% 
  left_join(cc_blocks %>% select(GEOID10)) %>% 
  st_as_sf() %>% 
  filter(
    !(ALAND10 == 0)
  )

mapview(richmond_blocks)

## getting isochrones
# isochrones <- mb_isochrone(
#   richmond_blocks,
#   profile = "walking",
#   time = c(5,10,15)
# )  %>% 
#   mutate(
#     mode = "walking"
#   )
# 
# isochrones_cycling <- mb_isochrone(
#     richmond_blocks,
#     profile = "cycling",
#     time = c(5,10,15)
# )  %>% 
#   mutate(
#     mode = "biking"
#   )
# 
# isochrones_driving <- mb_isochrone(
#     richmond_blocks,
#     profile = "driving",
#     time = c(5,10,15)
# ) %>% 
#   mutate(
#     mode = "driving"
#   )
# 
# isochrones <- isochrones %>% 
#   rbind(isochrones_cycling) %>% 
#   rbind(isochrones_driving)
#
# saveRDS(isochrones, "richmond_isochrones.rds")

isochrones <- readRDS("richmond_isochrones.rds")

isochrones <- richmond_blocks %>% 
  mutate(
    id = 1:n()
  ) %>% 
  st_drop_geometry() %>% 
  select(id, GEOID10) %>% 
  left_join(isochrones) %>% 
  st_as_sf()

isochrones <- readRDS("richmond_isochrones.rds")

mapview(isochrones) + mapview(richmond_blocks)
```

## creating data with POIS

The POI data was filtered to only include those points of interest that were tagged as the following amenity types: "convenience", "restaurant", "supermarket", "hospital", "pharmacy", "school", "library", "community_centre", "arts_centre", "park".

Hospital was added as it is a critical part of health infrastructure and should be accessible to everyone in the community to improve equitable health outcomes. Pharmacies follow a similar line of reasoning, where they provide an important health resource for a community.

"School" was included because schools are an important piece of education and amount of schools and access to those schools in a community can directly impact education outcomes. Research has shown... 

#### Omissions 

I initially included several more POIS, but these were removed as there were none within the area for the North Richmond community, given this specific data set. OF course, this data could have been missing from the data set. For the purpose of this analysis, the following amenities were deemed important but were ultimately removed as they had no relevant data.

*"doctors", "dentist", "shelter", "bus_stop", "tram_stop"*

## negative? fast food? 


```{r}
## Getting POI data
# pois <- st_read("/Volumes/GoogleDrive/Shared drives/SFBI/Data Library/OSM/gis_osm_pois_a_free_1.shp")
# 
# pois_filter <- pois %>%
#   rename(amenity = fclass) %>%
#   filter(amenity %in% c(
#     "convenience",
#     "restaurant",
#     "supermarket",
#     "hospital",
#     "pharmacy",
#     "school",
#     "library",
#     "community_centre",
#     "arts_centre",
#     "park"
#    ))
# 
# saveRDS(pois_filter, "pois_filter.rds")

pois_filter <- readRDS("pois_filter.rds")

access_raw <- isochrones %>% 
  st_make_valid() %>% 
  st_join(pois_filter) %>% 
  st_drop_geometry() %>% 
  filter(!is.na(osm_id))

amenity_preference <- data.frame(
  amenity = c(
    "convenience",
    "restaurant",
    "supermarket",
    "hospital",
    "pharmacy",
    "school",
    "library",
    "community_centre",
    "arts_centre",
    "park"),
  amenity_value = c(
    
  ),
  amenity_quantity = c(
    
  )
) %>% 
  mutate(
    amenity_decay = -log(0.5)/amenity_quantity
  )

mode_preference <- data.frame(
  mode = c(
    "walking",
    "biking",
    "driving"
  ),
  mode_value = c(
    1,
    0.6,
    0.5
  ),
  mode_reasonable = c(
    12,
    10,
    15
  )
) %>% 
  mutate(
    mode_decay = -log(0.5)/mode_reasonable
  )
```

























