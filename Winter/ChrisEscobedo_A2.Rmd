---
title: "ChrisEscobedo_A2"
author: "Chris"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: html_document  
---

```{r, include = F}
knitr::opts_chunk$set(echo = F, warnings = F, message = F)
```

```{r, include = F, warning = FALSE}
library(tidyverse)
library(sf)
library(tigris)
library(censusapi)
library(mapview)
library(leaflet)
library(mapboxapi)
library(readxl)
```

## Location

I choose North Richmond as a place to perform the equity analysis on the city completeness score becasue North Richmond is a particularly diverse area of one of the most diverse cities. It was also designated as an opportunity zone, which means that there is likely to be a need for investment in the area.

```{r, include = F, warning = FALSE}
cc_blocks <- blocks("CA","Contra Costa")

richmond_boundary <- places("CA") %>% 
  filter(NAME == "North Richmond")

richmond_blocks <- cc_blocks %>% 
  st_centroid() %>% 
  .[richmond_boundary, ] %>% 
  st_drop_geometry() %>% 
  left_join(cc_blocks %>% select(GEOID10)) %>% 
  st_as_sf() %>% 
  filter(
    !(ALAND10 == 0)
  )

mapview(richmond_blocks)

## getting isochrones
# isochrones <- mb_isochrone(
#   richmond_blocks,
#   profile = "walking",
#   time = c(5,10,15)
# )  %>% 
#   mutate(
#     mode = "walking"
#   )
# 
# isochrones_cycling <- mb_isochrone(
#     richmond_blocks,
#     profile = "cycling",
#     time = c(5,10,15)
# )  %>% 
#   mutate(
#     mode = "biking"
#   )
# 
# isochrones_driving <- mb_isochrone(
#     richmond_blocks,
#     profile = "driving",
#     time = c(5,10,15)
# ) %>% 
#   mutate(
#     mode = "driving"
#   )
# 
# isochrones <- isochrones %>% 
#   rbind(isochrones_cycling) %>% 
#   rbind(isochrones_driving)
#
# saveRDS(isochrones, "richmond_isochrones.rds")

isochrones <- readRDS("richmond_isochrones.rds")

isochrones <- richmond_blocks %>% 
  mutate(
    id = 1:n()
  ) %>% 
  st_drop_geometry() %>% 
  select(id, GEOID10) %>% 
  left_join(isochrones) %>% 
  st_as_sf()

isochrones <- readRDS("richmond_isochrones.rds")
```

```{r, include = F, warning = FALSE}
path <- "/Volumes/GoogleDrive/Shared drives/SFBI/Data Library/NHTS/nhts17-caltrans-tsdc-download/"

survey_household <- read_csv(paste0(path,"survey_household.csv"))

survey_person <- read.csv(paste0(path,"survey_person.csv")) 

survey_trip <- read_csv(paste0(path,"survey_trip.csv"))

survey_person_weights_7day <- read_csv(paste0(path,"survey_person_weights_7day.csv"))

nhts_lookup <- read_excel(
  paste0(path,"data_elements.xlsx"), 
  sheet = "Value Lookup"
)

## link weights to survey_person
person_weights <-
  survey_person %>% 
  left_join(
    survey_person_weights_7day %>% 
      select(
        sampno,
        perno,
        wttrdfin
      ),
    by = c("sampno","perno")
  )

## get geographies for bay area of CBSA's
cc_county <-
  counties("CA", cb = T, progress_bar = F) %>%
  filter(NAME %in% "Contra Costa")

cbsas <- core_based_statistical_areas(cb = T, progress_bar = F)

richmond_cbsas <-
  cbsas %>%
  .[cc_county %>% st_centroid(), ]
```

## Building a "Completeness Score"

To begin building the score for the preference of mode of travel, I used the median length of trips using each mode to create a score for the "reasonable travel distance" for each mode. This will then be used to create the "decay" of value for POIs around North Richmond. Below is a map of the CBSA that was used to collect this trip data.

```{r, warning = F}
## map
leaflet(richmond_cbsas) %>% 
  addTiles() %>% 
  addPolygons(
    label = ~paste0(GEOID,": ",NAME)
  )
```

```{r, include = F}
## combine dataset
richmond_trips <-
  survey_trip %>% 
  left_join(
    survey_person,
    by = c("sampno","perno")
  ) %>% 
  left_join(
    survey_person_weights_7day %>% 
      select(
        sampno,
        perno,
        wttrdfin
      ),
    by = c("sampno","perno")
  ) %>% 
  left_join(
    survey_household %>% select(
      sampno,
      hh_cbsa
    )
  ) %>% 
  filter(hh_cbsa %in% richmond_cbsas$GEOID)

## look at trip purpose
purpose_lookup <-
  nhts_lookup %>% 
  filter(NAME == "WHYTO") %>% 
  select(VALUE, LABEL) %>% 
  mutate(
    VALUE = as.numeric(VALUE),
    LABEL = factor(LABEL, levels = LABEL)
  )

## look at mode
mode_lookup <-
  nhts_lookup %>% 
  filter(NAME == "TRPTRANS") %>% 
  select(VALUE, LABEL) %>% 
  mutate(
    VALUE = as.numeric(VALUE),
    LABEL = factor(LABEL, levels = LABEL)
  )
```

Below is a table with the mean of trip distance for each "mode" of travel, taken from the CBSA used to determine a "reasonable travel distance".

```{r, warning = F}
richmond_trips_summary <-
  richmond_trips %>% 
  left_join(
    purpose_lookup,
    by = c("whyto" = "VALUE")
  ) %>% 
  rename(purpose_label = LABEL) %>% 
  left_join(
    mode_lookup,
    by = c("trptrans" = "VALUE")
  ) %>% 
  rename(mode_label = LABEL) %>% 
  mutate(
    tripmiles_wt =
      trpmiles * wttrdfin
  ) %>% 
  group_by(
    purpose_label,
    mode_label
  ) %>% 
  summarize(
    tripmiles_wt = sum(tripmiles_wt),
    trips = sum(wttrdfin)
  ) %>% 
  mutate(
    mean = tripmiles_wt/trips
  ) %>% 
  ungroup() %>% 
  filter(mode_label == c("Car", "Walk", "Bicycle")) %>% 
  group_by(
    mode_label
  ) %>% 
  summarize(mean = mean(mean)
  ) %>% 
  mutate(
    mode = case_when(
      mode_label == "Walk" ~ "walking",
      mode_label == "Bicycle" ~ "biking",
      mode_label == "Car" ~ "driving"
    )
  )

richmond_trips_summary
```

This mean, along with a subjective value given to each mode of travel, was used to create the mode scores seen in the following table.

```{r, warning = F}
mode_preference <- data.frame(
  mode = c(
    "walking",
    "biking",
    "driving"
  ),
  mode_value = c(
    1,
    0.6,
    0.5
  )
) %>% 
  left_join(
    richmond_trips_summary %>% select(mean, mode)
) %>% 
  mutate(
    mode_reasonable = mean,
    mode_decay = -log(0.5)/mode_reasonable
  )

mode_preference
```

## Building amenity scores 

The scores for each type of amenity in a city were given subjectively. It uses a ranking system, from 0 to 1, for each type of amenity. It also uses a ranking system for the quantity of that amenity. This number ranges from 1 to 35, meant to represent how much of a certain type of amenity would be valued and beyond which number would that amenity no longer hold much value. 

Below is a table outlining the amenity score components.

```{r, warning = F}
amenity_preference <- data.frame(
  amenity = c(
    "convenience",
    "restaurant",
    "supermarket",
    "hospital",
    "pharmacy",
    "school",
    "library",
    "community_centre",
    "arts_centre",
    "park"),
  amenity_value = c(
    0.1,
    0.8,
    1,
    1,
    0.6,
    0.9,
    0.3,
    0.6,
    0.4,
    0.9
  ),
  amenity_quantity = c(
    1,
    35,
    4,
    1,
    1,
    2,
    1,
    1,
    1,
    2
  )
) %>% 
  mutate(
    amenity_decay = -log(0.5)/amenity_quantity
  )


amenity_preference
```

## Applying subjective scores to POIs 

The amenity and mode scores are then used to obtain a value for each POI, which allows us to give a score to each census block in North Richmond based on its "completeness".

The POI data for the region was filtered to only include those points of interest that were tagged as the following amenity types: "convenience", "restaurant", "supermarket", "hospital", "pharmacy", "school", "library", "community_centre", "arts_centre", "park".

Hospital was added as it is a critical part of health infrastructure and should be accessible to everyone in the community to improve equitable health outcomes. Pharmacies follow a similar line of reasoning, where they provide an important health resource for a community.

"School" was included because schools are an important piece of education and amount of schools and access to those schools in a community can directly impact education outcomes. Although the amount of schools does not determind wether they will be resourced appropriately and whether they will have too many students, it can serve as a proxy for that for this analysis, where we assume more schools means more resources and less overcrowding.

Community Centers and Ats Centers are an important part of civil life, as they give space for deliberation, gathering, and community building. It is not always considered critical infrastructure, but its potential benefit for psychological well being are important.

#### Omissions 

I initially included several more POIS, but these were removed as there were none within the area for the North Richmond community, given this specific data set. This data may have been missing from an incomplete data set, but their absence altogether may point to other important possible conclusions, such as North Richmond being excluded from public transport. For the purpose of this analysis, the following amenities were deemed important but were ultimately removed as they had no relevant data in the North Richmond area.

*"doctors", "dentist", "shelter", "bus_stop", "tram_stop"*


```{r, warning = FALSE}
## Getting POI data
# pois <- st_read("/Volumes/GoogleDrive/Shared drives/SFBI/Data Library/OSM/gis_osm_pois_a_free_1.shp")
# 
# pois_filter <- pois %>%
#   rename(amenity = fclass) %>%
#   filter(amenity %in% c(
#     "convenience",
#     "restaurant",
#     "supermarket",
#     "hospital",
#     "pharmacy",
#     "school",
#     "library",
#     "community_centre",
#     "arts_centre",
#     "park"
#    ))
# 
# saveRDS(pois_filter, "pois_filter.rds")

pois_filter <- readRDS("pois_filter.rds")

access_raw <- isochrones %>% 
  st_make_valid() %>% 
  st_join(pois_filter) %>% 
  st_drop_geometry() %>% 
  filter(!is.na(osm_id))
```

## Baseline Hypothetical Completeness 


The following table shows a preview of the scores for each amenity in a hypothetical "complete city". It shows what the decay and score would be for each amenity if a city had the exact amount of each amenity that was determined to make it "complete" in the subjective valuation. This data will be used to measure against the reality of North Richmond.

```{r, warning = F}
## making a baseline hypothetical
complete_baseline <- data.frame(
  amenity = amenity_preference$amenity %>% 
    rep(amenity_preference$amenity_quantity)
) %>% 
  left_join(
    amenity_preference,
    by = "amenity"
  ) %>% 
  group_by(amenity) %>% 
  mutate(
    amenity_rank = row_number() - 1
  ) %>% 
  ungroup() %>% 
  mutate(
    score = amenity_value * exp(-amenity_rank * amenity_decay) * 0.5
  )


complete_baseline
```
Below is the complete score for a 100% complete hypothetical city. This would be if a city had every amenity in the exact quantity listed in the subjective score table. 

```{r, warning = F}
sum(complete_baseline$score)
```

Below is a map for North Richmond which depicts the subjective "completeness" score for each census block. As expected, the numbers are much lower than the hypothetical perfect city. The higher scores tend to be to the Southeast which als makes sense, given the fact that they are closer to the center of the downt town area of Richmond. 

```{r, warning=F}
complete_temp <- access_raw %>% 
  left_join(
    amenity_preference,
    by = "amenity"
  ) %>% 
  left_join(
    mode_preference,
    by = "mode"
  ) %>% 
  group_by(id, mode, amenity) %>% 
  arrange(time) %>% 
  mutate(
    amenity_rank = row_number() - 1
  ) %>% 
  ungroup()

## making complete modes
complete_modes <- complete_temp %>% 
  mutate(
    score = amenity_value * exp(-amenity_rank * amenity_decay) * exp(-time * mode_decay)
  ) %>% 
  group_by(id, mode) %>% 
  arrange(desc(score)) %>% 
  filter(!duplicated(osm_id)) %>% 
  summarize(
    score = sum(score, na.rm = T) / sum(complete_baseline$score)
  )

## make a score
complete_total <- complete_temp %>% 
  mutate(
    score = amenity_value * exp(-amenity_rank * amenity_decay) * mode_value * exp(-time * mode_decay)
  ) %>% 
  group_by(id) %>% 
  arrange(desc(score)) %>% 
  filter(!duplicated(osm_id)) %>% 
  summarize(
    score = sum(score, na.rm = T) / sum(complete_baseline$score)
  ) %>% 
  mutate(
    mode = "total"
  )

## make complete data frame
complete <- rbind(
  complete_modes,
  complete_total
) 

complete_map <- complete %>% 
  pivot_wider(
    names_from = "mode",
    values_from = "score"
  ) %>% 
  cbind(richmond_blocks %>% select(GEOID10)) %>% 
  st_as_sf

complete_pal <- colorNumeric(
  palette = "RdYlGn",
  domain = complete_map$total
)

leaflet() %>% 
  addProviderTiles(provider = providers$CartoDB.Positron) %>% 
  addPolygons(
    data = complete_map,
    fillColor = ~complete_pal(total),
    color = "black",
    weight = 0.5,
    opacity = 0.5,
    fillOpacity = 0.8,
    label = ~paste0("GEOID: ",GEOID10,", Score: ", round(total, digits = 3)),
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>% 
  addLegend(
    data = complete_map,
    pal = complete_pal,
    values = ~total,
    title = "Completeness Score for<br>census blocks in North Richmond"
  )

```

## Equity Analysis

Now we will look at the income and racial breakdowns of North Richmond as a whole and for each score. To do this, I first rounded the completeness scores to the hundredth place to create more analyzable buckets of scores. I then used 2020 decennial census data to get race and population data for each North Richmond census block.

I then combined the race data into a range of "buckets" of completeness scores. These buckets were created using the rounded scores of each block group. The buckets ranged from scores of 0.26 to 0.34., creating 9 total buckets. Then, for each bucket, the plot below provides a breakdown of the racial demographics for census blocks that match that score. 

The plot below thus provides a rough break down of racial equity for "completeness" for North Richmond. 

```{r, warning=F}
dec_vars_2020 <- read_csv("DECENNIALPL2020.P1_metadata.csv")

names(dec_vars_2020) <- dec_vars_2020[1,]

dec_vars_2020 <- dec_vars_2020 [2:10,] %>% 
   mutate(
    name = NAME,
    label = `Geographic Area Name`
   )

census_race_categories <- 
  c(
    "White Alone",
    "Black or African American",
    "American Indian and Alaska Native Alone",
    "Asian Alone",
    "Native Hawaiian and Other Pacific Islander Alone",
    "Some Other Race Alone",
    "Two or More Races"
  )

richmond_score_race <- read_csv("DECENNIALPL2020.csv") %>% 
  .[-1,] %>% 
  select(!c(NAME)) %>%
  pivot_longer(
    ends_with("N"),
    names_to = "name",
    values_to = "estimate"
  ) %>% 
  left_join(
    dec_vars_2020 %>% 
    select(name, label)
  ) %>% 
  filter(!is.na(label)) %>% 
  select(-name) %>% 
  separate(
    label,
    into = c(NA,NA,"multiple","race"),
    sep = "!!"
  ) %>% 
  mutate(
    race = if_else(is.na(race) & multiple == 'Population of two or more races:',
      'two or more races',
      race
    )
  ) %>% 
  filter(!is.na(race)) %>% 
  mutate(
    GEOID10 = str_remove_all(GEO_ID, "1000000US")
  ) %>%
  select(-c(GEO_ID, multiple)) %>%
  filter(GEOID10 %in% richmond_blocks$GEOID10) %>% 
  left_join(complete_map %>% 
    select(GEOID10, total)
  ) %>% 
  mutate(
    bucket = as.character(round(total, 2))
  )

richmond_race_total <-
  richmond_score_race %>% 
  group_by(race) %>% 
  summarize(estimate = sum(as.numeric(estimate))) %>%
  mutate(bucket = "Total")

richmond_score_race %>% 
  group_by(bucket, race) %>% 
  summarize(estimate = sum(as.numeric(estimate))) %>% 
  rbind(richmond_race_total) %>% 
  ggplot() +
  geom_bar(
    aes(
      x = bucket %>% factor(levels = rev(c("Total","0.26", "0.27","0.28","0.29","0.3","0.31","0.32","0.33","0.34"))),
      y = estimate,
      fill = race %>% factor(levels = rev(unique(richmond_score_race$race)))
    ),
    stat = "identity",
    position = "fill"
  ) +
  labs(
    x = "Rounded Score Buckets",
    y = "Proportion of Households",
    title = "North Richmond Block Scores by Race",
    fill = "Race Makeup of Score Bucket"
  ) +
  coord_flip() +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical"
  )  +
  guides(
    fill = guide_legend(
      reverse = T
    )
  )
```
### Discussion

Clearly, there is an outlier in the 0.33 bucket, where white is vastly over represented. This is likely one very segregated block in North Richmond which skews the representation of the whole community. It is important data, as segregation is a large factor in equity, but given the method of data collection, where a small number of blocks are being siphoned into a smaller number of buckets, this may be the case where one bucket does not have a large sample size, so one block skews the representation dramatically. On a similar note, it is important to remember that for all of these buckets, the sample size may vary and so over representation of certain blocks may be present. 

Still, the equity analysis does provide useful insights. There seems to be under-representation of the white population in the lower half of the scores, those below 0.3. The proportions of white population above 0.3 are on average higher than the total proportions of the white populations. This implies that the white population are over represented in blocks with higher score, or that the outcomes for city "completeness" are better for the white population in North Richmond. 

Another clear pattern is that the population that is Native American and Native Hawaiian are both largely over represented in the lower score buckets. This indicates that those populations have some of the most negative and least equitable outcomes for city "completeness" in North Richmond. There is a similar pattern with the Black population, though it is much less pronounced.

Interestingly, ta very large proportion of the population of North Richmond identifies as "some other race alone". Although being hispanic/latinx is considered an ethnicity and not a race, it is possible that this number is so high because the latinx population identified as "some other race alone". This would make sense to partially explain this large proportion, given the fact that Richmond has a very large latinx population. If we assume that most of the "some other race alone" population this is the latinx population, than there are further insights in the equity analysis presented. There is a large over-representation of this group in the lower scores, indicating that this part of the population has more negative outcomes in general for city "completeness". 

In conclusion, the equity analysis showed different outcomes for several race categories in North Richmond. Given what the score represents, this indicates that some populations have less access to what this report deemed as critical to being a complete community. Thus, those with over-representation in the higher scores, such as the white population, would have more access to a larger number of amenities, like schools, restaurants, grocery stores, etc. This preliminary report could then be used to increase access to critical infrastructure in more targeted areas of this communtiy and especially to those people of color in this community that are seeing worse outcomes.

Furthermore, the scores of .26-.34 are much lower than the hypothetical perfect score of 14.8. This is expected, but the lowness does indicate that North Richmond may be lacking in access to some critical amenities. Further research to compare this to other cities and communities would be interesting to illuminate the meaning of this score for the North Richmond community.






