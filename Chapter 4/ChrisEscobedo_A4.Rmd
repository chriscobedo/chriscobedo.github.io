---
title: "ChrisEscobedo_A4"
author: "Chris"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: html_document
---

```{r, include = F}
knitr::opts_chunk$set(echo = F, warnings = F, message = F)
```

```{r}
library(tidyverse)
library(sf)
library(leaflet)
library(tigris)
library(censusapi)

Sys.setenv(CENSUS_KEY="c7ce771b506b13ca6875d12a179606f8087fa381")
```

```{r, include = F}
acs_vars_2019_5yr <-
  listCensusMetadata(
    name = "2019/acs/acs5",
    type = "variables"
  )

census_race_categories <- 
  c(
    "White Alone",
    "Black or African American",
    "American Indian and Alaska Native Alone",
    "Asian Alone",
    "Native Hawaiian and Other Pacific Islander Alone",
    "Some Other Race Alone",
    "Two or More Races"
  )

white_education <- getCensus(
      name = "acs/acs5",
      vintage = 2019,
      region = "county:001",
      regionin = "state:06",
      vars = paste0("group(C15002A)")
    )

alameda_education_race <-
  1:7 %>% 
  map_dfr(function(x){
    getCensus(
      name = "acs/acs5",
      vintage = 2019,
      region = "county:001",
      regionin = "state:06",
      vars = paste0("group(C15002",LETTERS[x],")")
    ) %>%
      select(!c(GEO_ID,state,NAME) & !ends_with(c("EA","MA","M"))) %>%
      pivot_longer(
        ends_with("E"),
        names_to = "name",
        values_to = "estimate"
      ) %>%
      left_join(
        acs_vars_2019_5yr %>% 
          select(name, label)
      ) %>% 
      select(-name) %>% 
      separate(
        label,
        into = c(NA,NA,"sex", "education"),
        sep = "!!"
      ) %>% 
      filter(!is.na(education)) %>% 
      mutate(race = census_race_categories[x]) %>% 
      group_by(education, race) %>% 
      summarize(estimate = sum(estimate))
  }) 

total_alameda_race <- 
  alameda_education_race %>% 
  group_by(race) %>% 
  summarize(estimate = sum(estimate)) %>% 
  mutate(education = "Total")
```

```{r}
alameda_education_race %>% 
  rbind(total_alameda_race) %>% 
  ggplot() +
  geom_bar(
    aes(
      x = education %>% factor(levels = rev(c("Total","Less than high school diploma","High school graduate (includes equivalency)","Some college or associate's degree","Bachelor's degree or higher"))),
      y = estimate,
      fill = race %>% factor(levels = rev(unique(alameda_education_race$race)))
    ),
    stat = "identity",
    position = "fill"
  ) +
  labs(
    x = "Education Attainment",
    y = "Proportion of population 25 years or older",
    title = "Alameda educational attainment by race",
    fill = "Race"
  ) +
  coord_flip() +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical"
  )  +
  guides(
    fill = guide_legend(
      reverse = T
    )
  )
```

#### Discussion

The graph shows some slight over and under representations of race for some races. The white alone category is very underrepresented in the population with less than a high school diploma. The white alone category is slightly over represented in the populations with some college and with a bachelors degree. Black people are very underrepresented in those with a bachelors degree but underrepresented in those with less than a high school diploma as well. Its interesting to note that the category for "some other race alone" is extremely over represented in the population with less than a high school diploma and very underrepresented the populations with some college and with a bachelors degree. This map did not include ethnicity, so it may include those that are latinx or in some other race category. The map also includes only the population older than 25 years.

```{r, include = F}
census_ethnicity_categories <- 
  c(
    "White Alone, Not Latinx",
    "Latinx"
  )

alameda_education_ethnicity <-
  8:9 %>% 
  map_dfr(function(x){
    getCensus(
      name = "acs/acs5",
      vintage = 2019,
      region = "county:001",
      regionin = "state:06",
      vars = paste0("group(C15002",LETTERS[x],")")
    ) %>%
      select(!c(GEO_ID,state,NAME) & !ends_with(c("EA","MA","M"))) %>%
      pivot_longer(
        ends_with("E"),
        names_to = "name",
        values_to = "estimate"
      ) %>% 
      left_join(
        acs_vars_2019_5yr %>% 
          select(name, label)
      ) %>% 
      select(-name) %>% 
      separate(
        label,
        into = c(NA,NA,"sex", "education"),
        sep = "!!"
      ) %>% 
      filter(!is.na(education)) %>% 
      mutate(ethnicity = census_ethnicity_categories[x - 7]) %>% 
      group_by(education, ethnicity) %>% 
      summarize(estimate = sum(estimate))
  })

acs_vars_2019_1yr <-
  listCensusMetadata(
    name = "2019/acs/acs1",
    type = "variables"
  )

total_alameda_education <- 
  alameda_education_race %>% 
  group_by(education) %>% 
  summarize(estimate = sum(estimate)) %>% 
  mutate(ethnicity = "Total")
  
rows <- 1:4

alameda_education_all_ethnicity <- total_alameda_education %>% 
  rbind(alameda_education_ethnicity) 

for(row in rows){
  alameda_education_all_ethnicity[nrow(alameda_education_all_ethnicity) +1,] = c(
    education = alameda_education_all_ethnicity[row,1], 
    estimate = (as.numeric(alameda_education_all_ethnicity[row,2])) - (as.numeric(alameda_education_all_ethnicity[row+4,2])) - (as.numeric(alameda_education_all_ethnicity[row+8,2])),
    ethnicity = "Not White, Not Latinx")
}

total_alameda_ethnicity <- 
  alameda_education_all_ethnicity %>%
  filter(!ethnicity == "Total") %>% 
  group_by(ethnicity) %>% 
  summarize(estimate = sum(estimate)) %>% 
  mutate(education = "Total")
```

```{r}
alameda_education_all_ethnicity %>%
  filter(!ethnicity == "Total") %>% 
  rbind(total_alameda_ethnicity) %>% 
  ggplot() +
  geom_bar(
    aes(
      x = education %>% factor(levels = rev(c("Total","Less than high school diploma","High school graduate (includes equivalency)","Some college or associate's degree","Bachelor's degree or higher"))),
      y = estimate,
      fill = ethnicity %>% factor(levels = rev(unique(alameda_education_all_ethnicity$ethnicity)))
    ),
    stat = "identity",
    position = "fill"
  ) +
  labs(
    x = "Education Attainment",
    y = "Proportion of population 25 years or older",
    title = "Alameda educational attainment by ethnicity",
    fill = "Ethnicity"
  ) +
  coord_flip() +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical"
  )  +
  guides(
    fill = guide_legend(
      reverse = T
    )
  )
```

#### Discussion

Using this analysis that includes a breakdown of the latinx population, we can see new insights into the equity of education attainment. A disproportionate high amount of the latinx population has received less than a high school diploma. Furthermore, a disproportionately low amount of the latinx population has a bachelor's degree or higher. The trend is the exact reverse for the white population, which has less of the population with less than a high school diploma than expected and more of its population with a bachelor's degree of higher than expected. The "not white, not latinx" population as a whole does not see a lot of disproportionate representation in educational attainment.

It is important to remember that this dataset includes only the population of thecounty that is older than 25 years.