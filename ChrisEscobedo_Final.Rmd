---
title: "Final Assignment"
author: "Chris Escobedo"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: html_document  
---

```{r, include = F}
knitr::opts_chunk$set(echo = F, warnings = F, message = F)
```

```{r}
library(tidyverse)
library(mapview)
library(sf)
library(StatMatch)
library(leaflet)
library(tigris)
library(censusapi)
library(readxl)

Sys.setenv(CENSUS_KEY="c7ce771b506b13ca6875d12a179606f8087fa381")
```

## Introduction

In this project, I attempt to analyse the difference in food accessibility of different communities. I have heard through several classes about how lower income communities and communities of color often face the burden of lack of access to healthy food. In the urban system that is the Bay Area, many communities of concern, which already face multiple burdens, may not be able to access affordable healthy food, having access to more unhealthy, cheaper processed, fatty, and fast foods. Food insecurity and lack of food accessibility is a systemic issue that has many factors, including historical redlining, segregation, lack of investment, racial wealth disparities, and more. This topic has recently garnered more national attention and has a growing body of research. The Food Empowerment Project explains the idea of a “Food Apartheid”, which they prefer to the term Food Desert, as a lack of access to healthy foods from not only a lack of “proximity to food providers”, but also “considering other factors such as racism, cost of living, people being time poor and cash poor, cultural appropriateness of available foods, the ability of people to grow their owns foods, etc.” (https://foodispower.org/access-health/food-deserts/) 

What I am specifically interested in analyzing is how race might have a unique correlation with access to healthy foods. In other words, I am interested in controlling for income and looking at the correlation between healthy food access and race. This project looks at the correlation of race and income to access to healthy foods, individually and together.

As will be explained further in the "metrics" section, access to heatlhy food has been defined by an arbitraty choice of using the amount of grocery stores found within a mile of the center of a census tract. Although not the perfect metric for food accessibility, using this metric allows us to analyze food accesability in comparison to other useful census tract data, including race and income. 


```{r, warning = F}
bay_county_names <-
  c(
    "Alameda",
    "Contra Costa",
    "Marin",
    "Napa",
    "San Francisco",
    "San Mateo",
    "Santa Clara",
    "Solano",
    "Sonoma"
  )

bay_tracts <- tracts("CA", bay_county_names[1:9], cb = T, progress_bar = F) 

urban_cities <- 
  places("CA", cb = T, progress_bar = FALSE) %>% 
  filter(NAME %in% c("Oakland", "San Francisco", "San Jose","Fremont", "Santa Rosa", "Hayward", "Sunnyvale", "Santa Clara", "Vallejo", "Concord", "Berkeley"))

bay_city_tracts <-
  bay_tracts %>% 
  st_centroid() %>% 
  .[urban_cities, ] %>% 
  st_drop_geometry() %>% 
  left_join(bay_tracts %>% select(GEOID)) %>% 
  st_as_sf()

bay_tract_race_income <- 
  getCensus(
    name = "acs/acs5",
    vintage = 2019,
    region = "tract:*",
    regionin = "state:06+county:001,013,041,055,075,081,085,095,097",
    vars = c(
      "B19001_001E",
      "B19001_014E",
      "B19001_015E",
      "B19001_016E",
      "B19001_017E",
      "B19001A_001E"
    )
  ) %>% 
  transmute(
    tract = paste0(state, county, tract),
    perc_over100k = (B19001_014E + B19001_015E + B19001_016E + B19001_017E) / B19001_001E,
    perc_white = B19001A_001E / B19001_001E
  ) %>% 
  filter(
    !is.na(perc_over100k),
    !is.na(perc_white)
  ) %>% 
  right_join(
    bay_city_tracts %>% 
      select(GEOID),
    by = c("tract" = "GEOID"),
  ) %>% 
  st_as_sf()

## add counts of grocery stores through buffers

grocery_count_raw <- NULL

for(x in 1:3){
  filename <- paste0("Grocery_Point_", x, ".xlsx")
  
  temp <- read_excel(filename)
  
  grocery_count_raw <- rbind(grocery_count_raw, temp)
}

grocery_count_points <- grocery_count_raw %>% 
  mutate(
    long = as.numeric(Longitude),
    lat = as.numeric(Latitude)
  ) %>% 
  st_as_sf(coords = c("long", "lat"), crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0" )

bay_tract_buffer <- bay_tract_race_income %>% 
  st_centroid() %>% 
  st_transform(26910) %>% 
  st_buffer(1600)

bay_tract_grocery_counts <- NULL

num_bay_tracts <- 1:nrow(bay_tract_buffer)

for(x in num_bay_tracts){
  bay_tract_buffer_with_grocery <- grocery_count_points %>% 
    st_transform(26910) %>% 
    .[bay_tract_buffer[x,],] %>% 
    mutate(
      count_grocery = nrow(.)
    ) %>% 
    group_by(count_grocery) %>% 
    summarize() %>% 
    mutate(
      census_tract = bay_tract_buffer[x,1] %>% st_drop_geometry(),
      tract = census_tract$tract
    ) %>% st_drop_geometry()
  
  bay_tract_grocery_counts <- rbind(bay_tract_grocery_counts, bay_tract_buffer_with_grocery)
}

bay_tract_race_income_grocery <- bay_tract_race_income %>% 
  left_join(
    bay_tract_grocery_counts %>% select(tract, count_grocery)
  )

bay_tract_race_income_grocery[is.na(bay_tract_race_income_grocery)] = 0
```

## Maps of 11 Most Populated Cities

Below are two maps showing information for all census tracts for the 11 most populated cities in the Bay Area. These are the census tracts that will be used for the regression analysis to test correlation between access to healthy food, race, and income.

*Disclaimer*: It is important to note the assumptions that were made to create these maps and the potential issues with them. Each map also include its own set of disclaimers.

* Only the top most populated cities were chosen, perhaps leaving out valuable information from other cities. This was done to minimize the distortion that may have occurred from applying the same spatial analysis technique in an urban area and a rural area to determine access to healthy food. The number 11 was chosen arbitrarily.
* The census tracts were joined to the spatial locations of the cities using the "centroid" of the census tract, thus some census tracts that were within the boundary of the city in some way may have been left out of the analysis if the center was not within it.

#### Income

The map below shows the percentage of each census tracts that have an annual household income that is above $100k USD, over the point data of the grocery stores in the bay area. 

```{r, warning = F}
income_pal <- colorNumeric(
  palette = "Purples",
  domain = bay_tract_race_income$perc_over100k
)

leaflet() %>%
  addTiles() %>% 
  addPolygons(
    data = bay_tract_race_income,
    fillColor = ~income_pal(perc_over100k),
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.8,
    weight = 1,
    label = ~paste0(
      round(perc_over100k * 100), 
      "% of population that makes over 100k per household annually"
    ),
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>% 
  addLegend(
    data = bay_tract_race_income,
    pal = income_pal,
    values = ~perc_over100k,
    title = "Percentage of the population<br> that makes more than 100k USD<br>annualy per household"
  )
```

*Disclaimer*

* The decision to use 100k as the cutoff for higher income was a subjective choice chosen to be most representative of median income for the bay area. This number could have been different and the median income is certainly different for every census tract and representative of a different reality for different sized households.

#### Race

The Map Below shows the percentage of the population that is white for each census tract in the 11 most populated cities in the Bay Area.

```{r, warning = F}
race_pal <- colorNumeric(
  palette = "Blues",
  domain = bay_tract_race_income$perc_white
)

leaflet() %>%
  addTiles() %>% 
  addPolygons(
    data = bay_tract_race_income,
    fillColor = ~race_pal(perc_white),
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.8,
    weight = 1,
    label = ~paste0(
      round(perc_white * 100), 
      "% of population that is White Alone"
    ),
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>%
  addLegend(
    data = bay_tract_race_income,
    pal = race_pal,
    values = ~perc_white,
    title = "Percentage of the population<br> that is White alone"
  )
```

*Disclaimer*

* Since ethnicity is a separate question than race for the Census, any of the races may include the latinx population.

## Analysis 

### Metrics Used for Analysis

The metrics used for race and income are the same as for the maps above. Those metrics use data from the American Communities Survey 5 year estimates. The plots also include a new metric which we created to measure access to healthy food. The explanations of these metrics are below.

* The metric for income is the percentage of households that make more than 100,000 USD a year for each census tract. Thus, as a percentage increases, the more wealthy that census tract is on average.

* The metric for race is the percentage of the population that identifies as "White Alone" for their race for each census tract. Thus, as the percentage increases, the more white a census tract is.

* The metric for access to Healthy food is the total number of grocery stores found within a 1 mile radius from the center of the census tract, for each census tract. Thus, a higher number would likely indicate better access to healthy food.

*Disclaimers*

* The "access to healthy food" metric assumes that all grocery stores provide access to healthy foods. 
* The data for "grocery stores" in the bay area in 2019 came from "referenceusa.com" which may not include complete and fully accurate data. Furthermore, it was filtered for the data of businesses that are categorized as "5411 Grocery Stores" for the primary SIC prefix code, with "541103 - Convenience Stores" omitted. The 5411 categories includes different types of food retailers, which may include stores that do not typically provide healthy fresh food, as a typical grocery store would. To account for this, the store data were filtered to only include those with square footage above 5,000. According to "Convenience Store News", the average square footage for convenience stores in 2019 was 3,225 https://issuu.com/ensembleiq/docs/csn-0620?fr=sMjM1NjgwODQ2MQ). Still, there may be other food stores larger than this or grocery stores smaller than this, so it is not a perfect representation of grocery stores. 
* The distance of a  mile radius from the center of the census tract was chosen to align with one of the accessibility metrics used by the USDA to measure low access to healthy food. This analysis could have used a different length as an accessibility metric and the results would change.
* The center of the census tract was chosen as the focal point because total count would not be easy to compare, as all census tracts have various shapes and areas. This assumes that the center of the census tract should give a accurate representation of the population of entire census tract, which may not be true for some areas.

## Plots of Race, Income, and Access to Healthy Food

Below are two plots. The first plot shows the correlation between our chosen metric for income and access to healthy food while the second plot shows the correlation between our chosen metric for race and access to healthy food.

```{r}
ggplot(
  data = bay_tract_race_income_grocery,
  aes(
    x = perc_over100k,
    y = count_grocery
  )
) +
  geom_point() +
  geom_smooth(method = "lm")

ggplot(
  data = bay_tract_race_income_grocery,
  aes(
    x = perc_white,
    y = count_grocery
  )
) +
  geom_point() +
  geom_smooth(method = "lm")
```

From the plots above, we can clearly see that race is positively correlated with our metric for access to healthy food. On the other hand, there is no immediately visible correlation between income and access to healthy food.

The plot below attempts to visualize the relationship of all three of these data sets.

This is a correlation plot of the percentage of white population, the percentage of the population with household income greater than 100k USD, and the amount of grocery stores within a mile radius of the center of the census tract for each census tract. The number of grocery stores are demonstrated using lighter and darker colors for each census tract.

```{r}
ggplot(
  data = bay_tract_race_income_grocery,
  aes(
      x = perc_white,
      y = perc_over100k
    )
) +
  geom_point(
    aes(
      color = count_grocery
    )
  )
```

## Linear Regression Analysis 

We will now more closely inspect these relationships with linear regression models. We will start by inspecting race and income separately in their relationship with access to healthy food. We will then perform multiple regression to inspect the relationship of both of them together.

#### Income

Below is the linear regression model for income and healthy food access. This model provides more insight into the trend that we could see in the correlation plot that appeared to show no apparent correlation between income levels and food access.

```{r}
income_model <- lm(count_grocery ~ perc_over100k, bay_tract_race_income_grocery)

summary(income_model)
```

The results from this linear regression are not significant. The coefficient does suggest that there is actually a slightly negative correlation between income and access to healthy food, however, since the standard error is very high and the results are not statistically significant, we cannot scientifically claim a correlation relationship.

#### Race

Below is the linear regression model for race and healthy food access. This model provides more insight into the trend that we could see in the correlation plot that showed a positive correlation between "whiteness" of a census tract and food access.

```{r}
race_model <- lm(count_grocery ~ perc_white, bay_tract_race_income_grocery)

summary(race_model)
```



#### Income and Race

Finally, below is the multiple regression model that shows the correlation of both race and income with access to healthy food.

```{r}
full_model <- lm(count_grocery ~ perc_over100k + perc_white, bay_tract_race_income_grocery)

summary(full_model)
```

This model includes statistically significant results for the correlation of both race and income with access to healthy food. 

In this model, we can see that the regression coefficient for income is -1.786 and that it is a significant result. This gives us the information that when we "control for race," income seems to be negatively correlated with access to healthy food. This is in line with the results from the single linear regression model, though that result was not statistically significant and this correlation is much stronger.

We can also see that the regression coefficient for race is 3.4265 and that this is also a statistically significant result. This tells us that when we "control for income", whiteness of a census tract seems to be strongly positively correlated with access to healthy foods. In fact, it is even more strongly correlated to access to healthy foods than we see in the singular regression model, without controlling for income. 

This model ... is good?

#### Discussion

We can see that, using our metrics as defined, there seems to be a large positive correlation between race and access to healthy food. That correlation becomes even stronger when controlling for income. That is to say, when a census tract has a higher white population, you can expect there to be more access to healthy food, as we have defined it in terms of grocery stores. 

For income, there seems to be a negative correlation between income and access to healthy food. The singular linear regression did not provide statistically significant results, but the multiple regression analysis did. That analysis showed that, when controlling for race, when a census tract has a lower income on average, you can expect there to be slightly more grocery stores. 

To be clear, we cannot assign any causality to these results, since we are only studying potential correlation. Therefore, we are not able to say that race or income are causing access to healthy foods to be higher or lower, only that there is some correlation between them.

It is important to note that all of the metrics we chose were subjectively created and could have changed the results of the models. The decision to use the count of grocery stores as the dependent variable was also a subjective choice that would provide different results than if we treated it as an independent variable. There are many other potential factors that impact these metrics, so it is impossible to perfectly represent them all in a study of correlation.


