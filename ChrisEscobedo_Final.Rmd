---
title: "Final Assignment"
author: "Chris Escobedo"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: html_document  
---

```{r, include = F}
knitr::opts_chunk$set(echo = F, warnings = F, message = F)
```

```{r}
library(tidyverse)
library(mapview)
library(sf)
library(StatMatch)
library(leaflet)
library(tigris)
library(censusapi)
library(readxl)

Sys.setenv(CENSUS_KEY="c7ce771b506b13ca6875d12a179606f8087fa381")
```

## Introduction



```{r, warning = F}
bay_county_names <-
  c(
    "Alameda",
    "Contra Costa",
    "Marin",
    "Napa",
    "San Francisco",
    "San Mateo",
    "Santa Clara",
    "Solano",
    "Sonoma"
  )

bay_tracts <- tracts("CA", bay_county_names[1:9], cb = T, progress_bar = F) 

urban_cities <- 
  places("CA", cb = T, progress_bar = FALSE) %>% 
  filter(NAME %in% c("Oakland", "San Francisco", "San Jose","Fremont", "Santa Rosa", "Hayward", "Sunnyvale", "Santa Clara", "Vallejo", "Concord", "Berkeley"))

bay_city_tracts <-
  bay_tracts %>% 
  st_centroid() %>% 
  .[urban_cities, ] %>% 
  st_drop_geometry() %>% 
  left_join(bay_tracts %>% select(GEOID)) %>% 
  st_as_sf()

bay_tract_race_income <- 
  getCensus(
    name = "acs/acs5",
    vintage = 2019,
    region = "tract:*",
    regionin = "state:06+county:001,013,041,055,075,081,085,095,097",
    vars = c(
      "B19001_001E",
      "B19001_014E",
      "B19001_015E",
      "B19001_016E",
      "B19001_017E",
      "B19001A_001E"
    )
  ) %>% 
  transmute(
    tract = paste0(state, county, tract),
    perc_over100k = (B19001_014E + B19001_015E + B19001_016E + B19001_017E) / B19001_001E,
    perc_white = B19001A_001E / B19001_001E
  ) %>% 
  filter(
    !is.na(perc_over100k),
    !is.na(perc_white)
  ) %>% 
  right_join(
    bay_city_tracts %>% 
      select(GEOID),
    by = c("tract" = "GEOID"),
  ) %>% 
  st_as_sf()

## add counts of grocery stores through buffers

grocery_count_raw <- NULL

for(x in 1:3){
  filename <- paste0("Grocery_Point_", x, ".xlsx")
  
  temp <- read_excel(filename)
  
  grocery_count_raw <- rbind(grocery_count_raw, temp)
}

grocery_count_points <- grocery_count_raw %>% 
  mutate(
    long = as.numeric(Longitude),
    lat = as.numeric(Latitude)
  ) %>% 
  st_as_sf(coords = c("long", "lat"), crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0" )

bay_tract_buffer <- bay_tract_race_income %>% 
  st_centroid() %>% 
  st_transform(26910) %>% 
  st_buffer(1600)

bay_tract_grocery_counts <- NULL

num_bay_tracts <- 1:nrow(bay_tract_buffer)

for(x in num_bay_tracts){
  bay_tract_buffer_with_grocery <- grocery_count_points %>% 
    st_transform(26910) %>% 
    .[bay_tract_buffer[x,],] %>% 
    mutate(
      count_grocery = nrow(.)
    ) %>% 
    group_by(count_grocery) %>% 
    summarize() %>% 
    mutate(
      census_tract = bay_tract_buffer[x,1] %>% st_drop_geometry(),
      tract = census_tract$tract
    ) %>% st_drop_geometry()
  
  bay_tract_grocery_counts <- rbind(bay_tract_grocery_counts, bay_tract_buffer_with_grocery)
}

bay_tract_race_income_grocery <- bay_tract_race_income %>% 
  left_join(
    bay_tract_grocery_counts %>% select(tract, count_grocery)
  )

bay_tract_race_income_grocery[is.na(bay_tract_race_income_grocery)] = 0

mapview(bay_tract_buffer) + mapview(grocery_count_points)
mapview(bay_tract_grocery_with_buffer)

```

### Census Tract Maps of 11 Most Populated Cities in the Bay Area

Below are three maps showing the census tracts for the 11 most populated cities in the Bay Area. These are the census tracts that will be used for the regression analysis to test correlation between access to healthy food, race, and income.

*Disclaimer*: It is important to note the assumptions that were made to create these maps, and the potential issues with them. Each map will also include its own set of disclaimers for its own use of data.

* Only the top most populated cities were chosen, perhaps leaving out valuable information from other cities. This was done to minimize the distortion that may have occurred from applying the same spatial analysis technique in an urban area and a rural area to determine access to healthy food. The number 11 was chosen arbitrarily.
* The census tracts were joined to the spatial locations of the cities using the "centroid" of the census tract, thus some census tracts that were within the boundary of the city in some way may have been left out of the analysis if the center was not within it.

#### Race

The Map Below shows the percentage of the population that is white for each census tract in the 11 most populated cities in the Bay Area.


```{r, warning = F}
race_pal <- colorNumeric(
  palette = "Blues",
  domain = bay_tract_race_income$perc_white
)

leaflet() %>%
  addTiles() %>% 
  addPolygons(
    data = bay_tract_race_income,
    fillColor = ~race_pal(perc_white),
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.8,
    weight = 1,
    label = ~paste0(
      round(perc_white * 100), 
      "% of population that is White Alone"
    ),
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>%
  addLegend(
    data = bay_tract_race_income,
    pal = race_pal,
    values = ~perc_white,
    title = "Percentage of the population<br> that is White alone"
  )
```

*Disclaimer*

* Since ethnicity is a separate question than race for the Census, any of the races may include the latinx population.

#### Income

The map below shows the percentage of each census tracts that have an annual household income that is above $100k USD, over the point data of the grocery stores in the bay area. 

```{r, warning = F}
income_pal <- colorNumeric(
  palette = "Purples",
  domain = bay_tract_race_income$perc_over100k
)

leaflet() %>%
  addTiles() %>% 
  addPolygons(
    data = bay_tract_race_income,
    fillColor = ~income_pal(perc_over100k),
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.8,
    weight = 1,
    label = ~paste0(
      round(perc_over100k * 100), 
      "% of population that makes over 100k per household annually"
    ),
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>% 
  addLegend(
    data = bay_tract_race_income,
    pal = income_pal,
    values = ~perc_over100k,
    title = "Percentage of the population<br> that makes more than 100k USD<br>annualy per household"
  )
```


*Disclaimer*

* The decision to use 100k as the cutoff for higher income was a subjective choice chosen to be most representative of median income for the bay area. This number could have been different and the median income is certainly different for every census tract and representative of a different reality for different sized households.

### Plots of Race, Income, and Access to Healthy Food

Below are two plots. The first plot shows the correlation between income and access to healthy food while the second plot shows the correlation between race and access to healthy food.

The index of access to Healthy food was created ...

*Disclaimers*

* The data for "grocery stores" in the bay area in 2019 came from "referenceusa.com" which may not include a complete and 100% accurate data set. Furthermore, it filters for business data that is categorized as "5411 Grocery Stores" for the primary SIC prefix code, with "541103 - Convenience Stores" omitted. The 5411 categories includes different types of food retailers, which may include some stores that do not typically provide healthy fresh food as a typical grocery store would. To account for this, the store data were filtered to only include those with square footage above 5,000. According to "Convenience Store News", the average square footage for convenience stores in 2019 was 3,225 https://issuu.com/ensembleiq/docs/csn-0620?fr=sMjM1NjgwODQ2MQ). Still, there may be other food stores larger than this or grocery stores smaller than this, so it is not a perfect representation of grocery stores. 
* The distance of a  mile radius from the center of the census tract was chosen to align with one of the accessibility metrics used by the USDA to measure low access to healthy food. This analysis could have used a different length as an accessibility metric and the results would change.
* The center of the census tract was chosen as the focal point because total count would not be easy to compare, as all census tracts have various shapes and areas. This assumes that the center of the census tract should give a accurate representation of the entire census tract, which may not be true for some areas.

```{r}
ggplot() +
  geom_point(
    data = bay_tract_race_income_grocery,
    aes(
      x = perc_over100k,
      y = count_grocery
    )
  )

ggplot() +
  geom_point(
    data = bay_tract_race_income_grocery,
    aes(
      x = perc_white,
      y = count_grocery
    )
  )
```

From the plots above, we can see that both race and income (DO OR DON't) seem to be correlated in some way to access to healthy food. 

The plot below will attempt to visualize the relationship of all three of these data sets.

This is a correlation plot of the percentage of white population, the percentage of the population with household income greater than 100k USD, and the amount of grocery stores within a five mile radius of the center of the census tract for each census tract. The amount of grocery stores are demonstrated using lighter and darker colors for each census tract.

```{r}
# ggplot(
#   data = bay_tract_race_income,
#   aes(
#       x = perc_white,
#       y = perc_over100k
#     )
# ) +
#   geom_point(
#     aes(
#       color = count_grocery
#     )
#   )
```

### Linear Regression Analysis 



```{r}
# food_access_model <- lm(count_grocery ~ perc_over100k + perc_white, bay_multiple_tract)
# 
# summary(food_access_model)
```








